<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>毕业论文 | Gridea</title>
<link rel="shortcut icon" href="https://wyjoutstanding.github.io//favicon.ico?v=1621760825770">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://wyjoutstanding.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="毕业论文 | Gridea - Atom Feed" href="https://wyjoutstanding.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="[toc]
摘要
随着生产力与科技的进步人们对新药物研发和新材料研究提出了更高的要求。基于第一性原理的密度泛函微扰理论（DFPT）在评估均匀电场和相关材料特性的响应中是最为先进的方法之一。但在分子模拟软件包 FHI-aims 中的 DFPT..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://wyjoutstanding.github.io/">
  <img class="avatar" src="https://wyjoutstanding.github.io//images/avatar.png?v=1621760825770" alt="">
  </a>
  <h1 class="site-title">
    Gridea
  </h1>
  <p class="site-description">
    温故而知新
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
      
        <a href="/news/" class="menu">
          news
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              毕业论文
            </h2>
            <div class="post-info">
              <span>
                2021-05-23
              </span>
              <span>
                78 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <p>[toc]</p>
<h1 id="摘要">摘要</h1>
<p>随着生产力与科技的进步人们对新药物研发和新材料研究提出了更高的要求。基于第一性原理的密度泛函微扰理论（DFPT）在评估均匀电场和相关材料特性的响应中是最为先进的方法之一。但在分子模拟软件包 FHI-aims 中的 DFPT 实现，矩阵的大内存消耗成为其大规模并行计算的瓶颈。本工作在国产超算神威太湖之光上实现一种分布式存储策略，并在此基础上实现动静态负载均衡，同时针对神威体系结构做了相应的并行和访存优化。为此消除了全局稀疏矩阵存储并采用局部稠密矩阵与通信过程来克服内存瓶颈。利用首次运行时间和积分格点的位置计算新负载分布来提升负载的均匀程度。采用MPI进程级并行，Athread线程级并行和SIMD数据级并行实现三级并行策略，利用DMA和神威体系结构特点实现访存优化。该工作首次将FHI-aims中的DFPT计算规模推向150,002原子，这为今后国产超算神威平台上分子模拟软件大规模并行化的实现和优化提供了重要参考。</p>
<h1 id="英文摘要">英文摘要</h1>
<p>With the progress of productivity and science and technology, people put forward higher requirements for new drug research and new material research.  First-principles density functional perturbation theory (DFPT) is one of the most advanced methods for evaluating the response of uniform electric fields and related material properties. However, in the DFPT implementation of molecular simulation software package FHI-aims, the large memory consumption of matrix becomes the bottleneck of its large-scale parallel computing. In this work, a distributed storage strategy is implemented on the domestic supercomputer Sunway TaihuLight, and on this basis, dynamic and static load balancing is realized. At the same time, corresponding parallelism and access storage are optimized according to the Sunway system structure. Therefore, the global sparse matrix storage is eliminated and the local dense matrix and communication process are adopted to overcome the memory bottleneck. The new load distribution is calculated by the first running time and the position of integrating grid points to improve the load uniformity. The three-level parallel strategy is implemented by using MPI process-level parallelism, Athread thread-level parallelism and SIMD data-level parallelism, and the access optimization is implemented by using the characteristics of DMA and Sunway architecture. This work, for the first time, increases the computational scale of DFPT in FHI-aims to 150,002 atoms, which provides an important reference for the future implementation and optimization of large-scale parallelization of molecular simulation software on domestic supercomputer Sunway platform.</p>
<h1 id="绪论">绪论</h1>
<h2 id="研究背景和意义">研究背景和意义</h2>
<p>目前，随着计算能力的蓬勃发展和生物医药、化学材料的计算需求大大增加，提高相应先进的计算模拟程序的并行效率和可扩展性势在必行，并行效率的提高意味着资源的利用率提高，计算成本降低，同时提高科学家的研究效率；可扩展性意味着将从前不可能计算的体系变为可能，科学家能够借此探索更多的医药和材料性质和结构。二者均对科学发展和社会生活具有广泛的促进动力。</p>
<h2 id="研究现状和挑战">研究现状和挑战</h2>
<p>密度泛函理论（DFT）目前被广泛应用于分子模拟，材料模拟等领域，是诺奖级别的贡献。而DFT基础发展起来的密度泛函微扰理论（Density Functional Pertubation Theory，DFPT）是本工作中所优化程序的理论核心，它能够直接将物理特性与通过实验测量所得到的响应特性联系起来，例如拉曼光谱，拉曼强度，声子色散和极化率等。</p>
<p>目前DFPT由于需要超大的计算量，因此主要应用于小体系。而如何增强DFPT的扩展性，将其测试体系推至一个新的高度还是一个很大的挑战。</p>
<h2 id="本文的研究内容和创新点">本文的研究内容和创新点</h2>
<p>基于第一性原理的大规模分子、材料模拟软件包FHI-aims在国产超算神威太湖之光上的并行优化。</p>
<p>优化内容主要包括以下几个方面：</p>
<ul>
<li>
<p>实现Hamiltonian矩阵分布式存储，将最大测试体系推至150,000原子；</p>
</li>
<li>
<p>改善负载均衡算法提升泊松求解器5%~10%的性能；</p>
</li>
<li>
<p>多级并行策略充分利用计算资源：进程间的MPI并行，线程级的athread并行和数据级的SIMD并行；</p>
</li>
<li>
<p>充分利用神威体系结构特点，利用DMA tiling等方法实现访存优化。</p>
</li>
</ul>
<h2 id="本文的组织结构和章节安排">本文的组织结构和章节安排</h2>
<p>本文以FHI-aims的DFPT模块在神威太湖之光上的优化为中心，设计了一系列的方法和实验。各章节安排如下：</p>
<ul>
<li>第一章：大致介绍了本文所优化程序的背景和意义，并阐述目前面对的挑战；</li>
<li>第二章：介绍了FHI-aims背景，DFPT理论框架和神威太湖之光相关知识；</li>
<li>第三章：阐述DFPT中产生内存瓶颈的原因，各类矩阵存储格式及转换和如何设计分布式Hamiltonian矩阵存储；</li>
<li>第四章：介绍了负载均衡算法的设计思路，并讨论它对泊松求解器的影响；</li>
<li>第五章：介绍了泊松求解器在神威太湖之光上的优化思路，包括热点定位，Fortran转为C语言，三级并行，DMA tiling优化访存等；</li>
<li>第六章：展示了各个优化手段的性能效果，并做了整体优化的强扩展测试，同时分析各类产生的现象；</li>
<li>第七章：总结本文的工作，并展望未来可能发展的方向。</li>
</ul>
<h1 id="背景">背景</h1>
<h2 id="fhi-aims">FHI-aims</h2>
<p>用于计算分子或材料科学计算的Fritz Haber Institute ab initio molecular simulation(FHI-aims)是基于量子力学第一性原理的全电子，全势的电子结构软件包。FHi-aims 具有高精度，高效率，可大规模并行等特点，被世界上许多研究机构和大学广泛应用在生物制药，新材料研发等领域。</p>
<p>FHI-aims 在制药领域有一个重要应用即模拟分子晶体的拉曼光谱。在工业上，十分关注药品的水溶性，热稳定性，压缩性等，而常见的退烧药，止疼药都以分子晶体的形式存在，如扑热息痛，阿司匹林等，通过 FHI-aims 程序计算出药物的拉曼光谱，可进一步探究扑热息痛和阿司匹林晶体的结构特征和各类性质的关系。它目前是由一个遍布全球的活跃的开发者社区进行维护，主要成员来自于 Fritz Haber Institute，杜克大学，中国科学技术大学等。</p>
<p>其中第一性原理又称“从头算(ab inito)”，指得是不借助任何经验的参数，仅凭一些基本的数据即可计算出分子或原子的性质。例如仅需给定当前体系中每个原子的三维坐标和对应的基函数，即可计算出该体系对应的须有有效性质。</p>
<h2 id="密度泛函微扰理论">密度泛函微扰理论</h2>
<p>基于DFT理论的密度泛函微扰理论可求解多种物理响应性质，例如拉曼强度，极化率，介电常数等。其主要理论框架见图xx，由DFT步骤计算出电子密度<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo></mrow><annotation encoding="application/x-tex">n(\textbf r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span></span></span></span>，在进入循环分别计算一阶响应密度矩阵</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>P</mi><mrow><mi>u</mi><mi>m</mi><mo separator="true">,</mo><mi>v</mi><mi>n</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><mi>f</mi><mo>(</mo><msub><mi>ϵ</mi><mi>i</mi></msub><mo>)</mo><mo>(</mo><msubsup><mi>C</mi><mrow><mi>u</mi><mi>m</mi><mo separator="true">,</mo><mi>i</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><msubsup><mi>C</mi><mrow><mi>v</mi><mi>n</mi><mo separator="true">,</mo><mi>i</mi></mrow><mrow><mo>(</mo><mn>0</mn><mo>)</mo></mrow></msubsup><mo>+</mo><msubsup><mi>C</mi><mrow><mi>u</mi><mi>m</mi><mo separator="true">,</mo><mi>i</mi></mrow><mrow><mo>(</mo><mn>0</mn><mo>)</mo></mrow></msubsup><msubsup><mi>C</mi><mrow><mi>v</mi><mi>n</mi><mo separator="true">,</mo><mi>i</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><mo>)</mo></mrow><annotation encoding="application/x-tex">P^{(1)}_{um,vn}=\sum_if(\epsilon_i)(C^{(1)}_{um,i}C^{(0)}_{vn,i}+C^{(0)}_{um,i}C^{(1)}_{vn,i})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.321108em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.327674em;vertical-align:-1.277669em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231360000000004em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231360000000004em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.4577719999999998em;vertical-align:-0.412972em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231360000000004em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231360000000004em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>(</mo><msub><mi>ϵ</mi><mi>i</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">f(\epsilon_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>指费米狄拉克分布（Fermi–Dirac distribution），<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span>表示系数展开系数。一阶响应电子密度计算公式为</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msup><mi>n</mi><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mrow><mi>u</mi><mi>m</mi><mo separator="true">,</mo><mi>v</mi><mi>n</mi></mrow></munder><msubsup><mi>P</mi><mrow><mi>u</mi><mi>m</mi><mo separator="true">,</mo><mi>v</mi><mi>n</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><msubsup><mi>χ</mi><mrow><mi>u</mi><mi>m</mi></mrow><mrow><mo>(</mo><mn>0</mn><mo>)</mo></mrow></msubsup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo><msubsup><mi>χ</mi><mrow><mi>v</mi><mi>n</mi></mrow><mrow><mo>(</mo><mn>0</mn><mo>)</mo></mrow></msubsup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>+</mo><munder><mo>∑</mo><mrow><mi>u</mi><mi>m</mi><mo separator="true">,</mo><mi>v</mi><mi>n</mi></mrow></munder><mo>(</mo><msubsup><mi>P</mi><mrow><mi>u</mi><mi>m</mi><mo separator="true">,</mo><mi>v</mi><mi>n</mi></mrow><mrow><mo>(</mo><mn>0</mn><mo>)</mo></mrow></msubsup><mrow><msubsup><mi>χ</mi><mrow><mi>u</mi><mi>m</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo><msubsup><mi>χ</mi><mrow><mi>v</mi><mi>n</mi></mrow><mrow><mo>(</mo><mn>0</mn><mo>)</mo></mrow></msubsup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo><mo>+</mo><msubsup><mi>χ</mi><mrow><mi>u</mi><mi>m</mi></mrow><mrow><mo>(</mo><mn>0</mn><mo>)</mo></mrow></msubsup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo><msubsup><mi>χ</mi><mrow><mi>v</mi><mi>n</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo></mrow><mo>)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
n^{(1)}(\textbf r) &amp;=\sum_{um,vn}P^{(1)}_{um,vn}\chi^{(0)}_{um}(\textbf r)\chi^{(0)}_{vn}(\textbf r)\\
&amp;+ \sum_{um,vn}(P^{(0)}_{um,vn}{\chi^{(1)}_{um}(\textbf r)\chi^{(0)}_{vn}(\textbf r)+\chi^{(0)}_{um}(\textbf r)\chi^{(1)}_{vn}(\textbf r)})
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.4722360000000005em;vertical-align:-2.4861180000000003em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9861180000000003em;"><span style="top:-4.986118em;"><span class="pstrut" style="height:3.0500050000000005em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.0500050000000005em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4861180000000003em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9861180000000003em;"><span style="top:-4.986118em;"><span class="pstrut" style="height:3.0500050000000005em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em;"><span style="top:-1.8999949999999999em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.386113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">χ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">χ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.0500050000000005em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em;"><span style="top:-1.8999949999999999em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.386113em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathdefault">χ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">χ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">χ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">χ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4861180000000003em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>χ</mi></mrow><annotation encoding="application/x-tex">\chi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">χ</span></span></span></span>表示波函数。一阶响应静电势计算为</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>V</mi><mrow><mi>e</mi><mi>s</mi><mo separator="true">,</mo><mi>t</mi><mi>o</mi><mi>t</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo><mo>=</mo><mo>(</mo><mfrac><mi mathvariant="normal">∂</mi><mrow><mi mathvariant="normal">∂</mi><msub><mtext mathvariant="bold">R</mtext><mrow><mi>I</mi><mi>s</mi></mrow></msub></mrow></mfrac><msup><mi>V</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>−</mo><msub><mtext mathvariant="bold">R</mtext><mrow><mi>I</mi><mi>s</mi></mrow></msub><mo>)</mo><mo>)</mo><mo>+</mo><munder><mo>∑</mo><mrow><mi>J</mi><mi>n</mi></mrow></munder><mi>δ</mi><msubsup><mi>V</mi><mrow><mi>J</mi><mi>n</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>−</mo><msub><mtext mathvariant="bold">R</mtext><mrow><mi>J</mi><mi>n</mi></mrow></msub><mo>)</mo><mo>)</mo></mrow><annotation encoding="application/x-tex">V^{(1)}_{es,tot}(\textbf r)=(\frac{\partial}{\partial \textbf R_{Is}}V^{free}(\textbf r- \textbf R_{Is}))+\sum_{Jn}\delta V^{(1)}_{Jn}(\textbf r- \textbf R_{Jn}))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.426664em;vertical-align:-0.381864em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.454244em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.381864em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.20744em;vertical-align:-0.8360000000000001em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord text"><span class="mord textbf">R</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">e</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord textbf">R</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.344341em;vertical-align:-1.294336em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em;"><span style="top:-1.855664em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.09618em;">J</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.294336em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4064690000000004em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.09618em;">J</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.293531em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord textbf">R</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.09618em;">J</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext mathvariant="bold">R</mtext><mrow><mi>I</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\textbf R_{Is}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83611em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord textbf">R</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>表示所有的周期性副本（periodic replicas），第二项可以通过<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>n</mi><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msup><mo>(</mo><mtext mathvariant="bold">r</mtext><mo>)</mo></mrow><annotation encoding="application/x-tex">n^{(1)}(\textbf r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">r</span></span><span class="mclose">)</span></span></span></span>计算而出。一阶响应哈密顿矩阵计算为</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>H</mi><mrow><mi>u</mi><mi>m</mi><mo separator="true">,</mo><mi>v</mi><mi>n</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>)</mo></mrow></msubsup><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msubsup><mi>H</mi><mrow><mi>u</mi><mo>(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo>)</mo><mo separator="true">,</mo><mi>v</mi><mn>0</mn></mrow><mrow><mo>(</mo><mn>0</mn><mo>)</mo></mrow></msubsup></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mtext mathvariant="bold">R</mtext><mrow><mi>I</mi><mo>(</mo><mi>s</mi><mo>−</mo><mi>n</mi><mo>)</mo></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">H^{(1)}_{um,vn}=\frac{\partial H^{(0)}_{u(m-n),v0}}{\partial \textbf R_{I(s-n)}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.321108em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.9911999999999996em;vertical-align:-1.0412em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.9499999999999997em;"><span style="top:-2.3588em;"><span class="pstrut" style="height:3.0448em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord text"><span class="mord textbf">R</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">s</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.2748em;"><span class="pstrut" style="height:3.0448em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.95em;"><span class="pstrut" style="height:3.0448em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.3598em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">m</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5151999999999999em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0412em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<figure data-type="image" tabindex="1"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/image-20210517132731710.png" alt="image-20210517132731710" loading="lazy"></figure>
<p>根据一阶电子密度的前后两次变化是否小于设定的阈值来判断是否收敛，若不收敛则继续重新DFPT循环计算，否则计算出极化率。</p>
<h2 id="神威太湖之光">神威太湖之光</h2>
<p>神威太湖之光是第一台全部采用国产处理器SW26010构建的超级计算机，曾连续三年蝉联计算速度世界第一的宝座。由国家并行计算机工程技术研究中心完整设计并实现部署，是世界上第一台理论峰值超过100PFlops的超级计算机。</p>
<p>SW26010处理器的结构如图xx所示，它采用片上异构的设计，一个处理器由4个核组构成，每个核组包含1个运算控制核心（主核）和1个从核阵列，从核阵列由64个运算核心（从核）组成。从核上由可灵活使用的大小为64KB的局部存储（Local Device Memory，LDM），开发者可充分利用以降低访存时间。</p>
<figure data-type="image" tabindex="2"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/image-20210517185239888.png" alt="image-20210517185239888" loading="lazy"></figure>
<p>[1]段晓辉. 基于“神威·太湖之光”的分子动力学算法优化[D].山东大学,2020.</p>
<h1 id="分布式存储矩阵">分布式存储矩阵</h1>
<p>FHI-aims 中，格点已经完成了分布式存储，而 Hamiltonian 矩阵依旧是以全局稀疏格式存储，每个进程都保存一份完整的稀疏矩阵。随着原子体系的增大，存储将成为系统扩展的重大瓶颈。从理论上深入分析，每个进程只计算部分的 Hamiltonian 矩阵元，因此只需在每个进程上存储与本进程计算相关的矩阵元，这为 Hamiltonian 矩阵的分布式存储提供了一个理论可能性。</p>
<h2 id="三类矩阵存储">三类矩阵存储</h2>
<p>FHI-aims 中涉及三种矩阵存储格式，压缩稀疏矩阵行（CSR），ScaLAPACK的分布式矩阵存储和NTPoly矩阵存储格式，CSR用于存储全局的Hamiltonian矩阵，ScaLAPACK用于分布式矩阵运算，NTPoly用于线性标度的密度矩阵运算。</p>
<h3 id="压缩稀疏矩阵行csr">压缩稀疏矩阵行CSR</h3>
<p>压缩稀疏矩阵行CSR(Compressed Sparse Row)是一种高效的稀疏矩阵存储的数据结构，与其相对应的还有压缩稀疏矩阵列CSC(Compressed Sparse Column)。该数据结构涉及两个过程：CSR结构的构造和还原，即稠密矩阵和CSR之间的转换。</p>
<h4 id="数据结构">数据结构</h4>
<p>CSR 由两个索引数组和一个值数组组成，假设N行M列的稠密矩阵有K个非零元：</p>
<ul>
<li>
<p>values 是长度为 K 的数组，用于按行序存储非零元；</p>
</li>
<li>
<p>row_index 是长度为 N+1 的数组，row_index[i] 和 row_index[i+1] 分别表示第i行非零元素在values中的起止索引（左闭右开）；</p>
</li>
<li>
<p>column_index 是长度为 K 的数组，用于存储 values[i] 的列索引。</p>
</li>
</ul>
<p>根据以上分析可得出 CSR 所需的内存空间为 2K+N+1，而稠密矩阵的存储需要的内存空间为 NM。因此，当 K&lt;(NM-N-1)/2 时，使用 CSR 存储结构更加节约空间，若 N/NM 可忽略不计时，矩阵稀疏度 K/NM 约等于 50%，即低于 50% 的稀疏度使用 CSR 是合适的。</p>
<h4 id="稠密矩阵构造csr">稠密矩阵构造CSR</h4>
<p>从稠密矩阵构造 CSR 的核心思想是维护一个非零元偏移计数器 disp，分别遍历每一行，在开始和结束遍历每一行时记录对应的行索引 row_index，在一行内，遍历每个元素，分别记录非零元的值与列索引在 values 和 column_index 中。其伪代码如下：</p>
<pre><code class="language-pseudocode">disp=0
for i in 0..N:
	row_index[i] = disp
	for j in 0..M:
		if (DenseMat[i][j] != 0):
			values[disp] = DenseMat[i][j]
			column_index[disp] = j
	row_index[i] = disp
</code></pre>
<h4 id="csr-还原稠密矩阵">CSR 还原稠密矩阵</h4>
<p>从 CSR 格式还原完整的稠密矩阵，最简单的思想是按行列序填充每个稠密矩阵的元素，对于每个元素，到对应的行索引中寻找与该元素列号相对应的列索引，从而获取到具体的数值。具体细节见伪代码xx，它的时间复杂度为O(KM)，其中 K 为矩阵的非零元总数，M 为稠密矩阵的列数。</p>
<pre><code class="language-pseudocode">for i in 0..N:
	for j in 0..M:
		for k in row_index[i]..row_index[i+1]:
            if (column_index[k] == j):
                DenseMat[i][j] = values[k]
</code></pre>
<p>但换个思路，从稀疏矩阵 CSR 角度出发，即按行遍历，在每一行中，遍历稀疏矩阵对应的行索引，进而在稠密矩阵中填充非零元。具体细节见伪代码xx，其时间复杂度为 O(K)，相比前一种思想，该方法省却了零元的访问，从而大幅减低时间复杂度。</p>
<pre><code class="language-pseudocode">for i in 0..N:
    for k in row_index[i]..row_index[i+1]:
        DenseMat[i][column_index[k]] = values[k]
</code></pre>
<p>在 FHI-aims 中，CSR 和稠密矩阵被广泛使用，它们之间的转换也颇为频繁。对于稠密矩阵，并非将其完整的存储在每个进程的物理空间中，而是分布式存储在每个进程上，以便于进行分布式矩阵运算，例如矩阵乘法，加法和转置等。而用 CSR 格式存储稀疏矩阵将减少在每个进程上的内存占用，从而提高内存利用率。</p>
<h3 id="scalapack的分布式矩阵存储">ScaLAPACK的分布式矩阵存储</h3>
<p>ScaLAPACK 是一个易扩展，高效率，移植性好和内存分布式存储的线性代数运算软件包，支持各类矩阵运算，特征值求解和线性方程求解等问题。FHI-aims采用该软件包进行分布式矩阵运算，其中涉及Hamiltonian矩阵和ScaLAPACK所支持的分布式矩阵存储格式进行通信转换的过程，精心设计的数据块循环分布的分布式存储思想让它能达到易扩展和负载均衡的理想效果。</p>
<p>在ScaLAPACK中针对不同的应用场景和数据，会采用不同的数据划分方法，例如求解问题中涉及带状矩阵或三角矩阵则采用一维数据块划分与一维进程数组进程分布；若涉及稠密矩阵，则采用二维数据块划分与二维进程网格分布。数据块循环分布顾名思义，可以直观拆分为先对数据分块，再以数据块为单位分配给不同进程两个部分。其中分块指将一组数据划分为指定大小且块内数据连续的数据块，分配意为将划分好的数据块，以Round-Robin算法（求模取余）计算出要分配的进程号。</p>
<h4 id="一维数据块循环分布">一维数据块循环分布</h4>
<p>数据块的循环分布是将一个数据块集合分配到各个进程上。也可以直观的理解为先将数据分块，然后以数据块为基本单位，分配给各个进程。</p>
<p>现假设有N个元素数组A（编号0...N-1）要分配给P个进程（编号0...P-1），指定数据块大小为NB，所有的编号均从0开始。</p>
<p><strong>（1）数据分块</strong>：N 个元素被划分为连续的大小为 NB 的块，若NB无法被N整除，则最后一个数据块大小为 MOD(N,NB)。</p>
<p><strong>（2）数据块循环分配</strong>：一个直观的分配方法为Round-Robin分配，即第k个数据块分配给编号为MOD(k,P)的进程。但为了便于具体的建立起全局索引和局部索引的映射关系，定义以下符号：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>g</mi><mi>I</mi></mrow><annotation encoding="application/x-tex">{gI}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span></span></span></span></span>：元素a在全局数组A中的索引/编号</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">{p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">p</span></span></span></span></span>：元素a所在的进程编号</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span></span></span>：元素a在其所属数据块内部的偏移量</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>b</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">{lbi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span></span></span></span></span>：元素a所属的数据块在其所属进程上的局部索引</li>
</ul>
<p>根据以上的定义，此时若给定一个元素的全局索引<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>g</mi><mi>I</mi></mrow><annotation encoding="application/x-tex">{gI}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span></span></span></span></span>，根据已知量数组A长度N，进程总数P和数据块大小NB可分别得到p，x，lbi的表达式：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>p</mi><mo>=</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mo>⌊</mo><mrow><mfrac><mrow><mi>g</mi><mi>I</mi></mrow><mrow><mi>N</mi><mi>B</mi></mrow></mfrac><mo>⌋</mo></mrow><mo separator="true">,</mo><mi>P</mi><mo>)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi><mo>=</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mrow><mi>g</mi><mi>I</mi></mrow><mo separator="true">,</mo><mi>N</mi><mi>B</mi><mo>)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi>l</mi><mi>b</mi><mi>i</mi></mrow><mo>=</mo><mo>⌊</mo><mfrac><mrow><mi>g</mi><mi>I</mi></mrow><mrow><mi>P</mi><mo>×</mo><mi>N</mi><mi>B</mi></mrow></mfrac><mo>⌋</mo></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{cases}
{p}=MOD(\lfloor{\frac{{gI}}{NB}\rfloor},{P}) \\
{x}=MOD({gI},NB) \\
{lbi}=\lfloor{\frac{{gI}}{P\times NB}}\rfloor
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.9099999999999997em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35002em;"><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.1500100000000004em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.30001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.60002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8500199999999998em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">p</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mopen">⌊</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.924439em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌋</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span><span class="mclose">)</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span><span style="top:-1.5300000000000002em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">⌊</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.924439em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span><span class="mbin mtight">×</span><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.403331em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mclose">⌋</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>有了以上三个基本量，还可以计算出元素a在进程p上的局部存储索引为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>l</mi><mi>b</mi><mi>i</mi></mrow><mo>×</mo><mi>N</mi><mi>B</mi><mo>+</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">{lbi}\times NB+{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span></span></span>。至此，给定任意的全局数组元素的索引，均可根据以上公式确定该元素归属的进程号和该元素在对应进程上的局部存储的索引位置。</p>
<p>如图xx所示，长度N=9的数组A先划分为多个大小为NB=2的数据块，A8单独作为一个数据块；数据块划分完成后，以块为基本单位，循环分配给P=3个进程，进程负责分配到的数据的存储与计算。</p>
<figure data-type="image" tabindex="3"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/FHI-aims_Matrix-scalapak_1D.svg" alt="FHI-aims_Matrix-scalapak_1D" loading="lazy"></figure>
<p>通常让每个进程知道局部元素对应的全局数组索引也很常见，因此我们还需要从局部索引到全局索引的转换：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>g</mi><mi>I</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mi>k</mi><mo>×</mo><mi>N</mi><mi>B</mi><mo>+</mo><mi>x</mi></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>(</mo><mrow><mi>l</mi><mi>b</mi><mi>i</mi><mo>×</mo><mi>P</mi><mo>+</mo><mi>p</mi></mrow><mo>)</mo><mo>×</mo><mi>N</mi><mi>B</mi><mo>+</mo><mi>x</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
{gI} &amp;={k\times NB+x} \\
		&amp;=({lbi\times P+p})\times NB+x
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.0000000000000004em;vertical-align:-1.2500000000000002em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">x</span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">p</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>可以发现，只需要映射时计算得到的 p，x和lbi，即可逆向计算出进程上局部数据对应的全局数组索引。</p>
<h4 id="二维数据块循环分布">二维数据块循环分布</h4>
<p>上文讨论了一维数据和一维进程网格间的映射关系，在此基础上，我们可以推出二维数据与二维进程网格间的映射关系。</p>
<p>现假设有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">{M\times N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span></span>个元素的矩阵A，要分配给<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>r</mi></msub><mo>×</mo><msub><mi>P</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">{P_r\times P_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 的二维进程网格，指定数据块大小为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>B</mi><mo>×</mo><mi>N</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">{MB\times NB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span></span>，所有的编号均从0开始。</p>
<p><strong>数据分块</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">{M\times N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span></span> 个元素被划分为连续的大小为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>B</mi><mo>×</mo><mi>N</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">{MB\times NB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span></span>的块，若MB无法被M整除，则最后一行分块时，行数为 MOD(MB,M)；若NB无法被N整除，则最后一列分块时，列数为 MOD(N,NB)。</p>
<p><strong>数据块循环分配</strong>：一个直观的分配方法为Round-Robin分配，即第<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;{i,j}&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>个数据块分配给编号为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mrow><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mi>i</mi><mo separator="true">,</mo><msub><mi>P</mi><mi>r</mi></msub><mo>)</mo><mo separator="true">,</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mi>j</mi><mo separator="true">,</mo><msub><mi>P</mi><mi>c</mi></msub><mo>)</mo></mrow><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;{MOD(i,P_r),MOD(j,P_c)}&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>的进程。但为了便于具体的建立起全局索引和局部索引的映射关系，定义以下符号：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mrow><mi>g</mi><mi>I</mi><mo separator="true">,</mo><mi>g</mi><mi>J</mi></mrow><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;{gI,gJ}&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>：元素a在全局矩阵A中的行列索引</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mrow><msub><mi>p</mi><mi>r</mi></msub><mo separator="true">,</mo><msub><mi>p</mi><mi>c</mi></msub></mrow><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;{p_r,p_c}&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>：元素a所在的进程行列索引</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">{&lt;x,y&gt;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span></span>：元素a在所属数据块内部的行列偏移量</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mrow><mi>l</mi><mi>b</mi><mi>i</mi><mo separator="true">,</mo><mi>l</mi><mi>b</mi><mi>j</mi></mrow><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;{lbi,lbj}&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>：在元素a所属的进程上，它所属的数据块在当前进程上的行列索引（局部编号）</li>
</ul>
<p>根据以上的定义，此时若给定一个元素的全局索引 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mi>g</mi><mi>I</mi><mo separator="true">,</mo><mi>g</mi><mi>J</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">{&lt;gI,gJ&gt;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span></span>，根据已知量矩阵大小<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">{M\times N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span></span>，进程总数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>r</mi></msub><mo>×</mo><msub><mi>P</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">{P_r\times P_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>和数据块大小<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>B</mi><mo>×</mo><mi>N</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">{MB\times NB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span></span>可得关键量的表达式：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mo>&lt;</mo><msub><mi>p</mi><mi>r</mi></msub><mo separator="true">,</mo><msub><mi>p</mi><mi>c</mi></msub><mo>&gt;</mo></mrow><mo>=</mo><mo>&lt;</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mo>⌊</mo><mrow><mfrac><mrow><mi>g</mi><mi>I</mi></mrow><mrow><mi>M</mi><mi>B</mi></mrow></mfrac><mo>⌋</mo></mrow><mo separator="true">,</mo><msub><mi>P</mi><mi>r</mi></msub><mo>)</mo><mo separator="true">,</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mo>⌊</mo><mrow><mfrac><mrow><mi>g</mi><mi>J</mi></mrow><mrow><mi>N</mi><mi>B</mi></mrow></mfrac><mo>⌋</mo></mrow><mo separator="true">,</mo><msub><mi>P</mi><mi>c</mi></msub><mo>)</mo><mo>&gt;</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>&gt;</mo></mrow><mo>=</mo><mo>&lt;</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mrow><mi>g</mi><mi>I</mi></mrow><mo separator="true">,</mo><mi>M</mi><mi>B</mi><mo>)</mo><mo separator="true">,</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mrow><mi>g</mi><mi>J</mi></mrow><mo separator="true">,</mo><mi>N</mi><mi>B</mi><mo>)</mo><mo>&gt;</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mo>&lt;</mo><mi>l</mi><mi>b</mi><mi>i</mi><mo separator="true">,</mo><mi>l</mi><mi>b</mi><mi>j</mi><mo>&gt;</mo></mrow><mo>=</mo><mo>&lt;</mo><mo>⌊</mo><mfrac><mrow><mi>g</mi><mi>I</mi></mrow><mrow><msub><mi>P</mi><mi>r</mi></msub><mo>×</mo><mi>M</mi><mi>B</mi></mrow></mfrac><mo>⌋</mo><mo separator="true">,</mo><mo>⌊</mo><mfrac><mrow><mi>g</mi><mi>J</mi></mrow><mrow><msub><mi>P</mi><mi>c</mi></msub><mo>×</mo><mi>N</mi><mi>B</mi></mrow></mfrac><mo>⌋</mo><mo>&gt;</mo></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{cases}
{&lt;p_r,p_c&gt;}=&lt;MOD(\lfloor{\frac{{gI}}{MB}\rfloor},{P_r}),MOD(\lfloor{\frac{{gJ}}{NB}\rfloor},{P_c})&gt; \\
{&lt;x,y&gt;}=&lt;MOD({gI},MB),MOD({gJ},NB)&gt; \\
{&lt;lbi,lbj&gt;}=&lt;\lfloor{\frac{{gI}}{P_r\times MB}}\rfloor,\lfloor{\frac{{gJ}}{P_c\times NB}}\rfloor&gt;
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.3331em;vertical-align:-1.91655em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35002em;"><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.1500100000000004em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.30001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.60002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8500199999999998em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41655em;"><span style="top:-4.41655em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mopen">⌊</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.924439em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌋</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mopen">⌊</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.924439em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight" style="margin-right:0.09618em;">J</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌋</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span><span style="top:-2.97655em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span><span style="top:-1.53655em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">⌊</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.924439em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.13889em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44509999999999994em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mclose">⌋</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">⌊</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.924439em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.13889em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight" style="margin-right:0.09618em;">J</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44509999999999994em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mclose">⌋</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91655em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>基于以上三个基本量，可以计算出指定元素<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mi>g</mi><mi>I</mi><mo separator="true">,</mo><mi>g</mi><mi>J</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">{&lt;gI,gJ&gt;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span></span>在进程<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mrow><msub><mi>p</mi><mi>r</mi></msub><mo separator="true">,</mo><msub><mi>p</mi><mi>c</mi></msub></mrow><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;{p_r,p_c}&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>上的局部存储位置为</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mrow><mi>l</mi><mi>b</mi><mi>i</mi></mrow><mo>×</mo><mi>M</mi><mi>B</mi><mo>+</mo><mi>x</mi><mo separator="true">,</mo><mrow><mi>l</mi><mi>b</mi><mi>j</mi></mrow><mo>×</mo><mi>N</mi><mi>B</mi><mo>+</mo><mi>y</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;{lbi}\times MB+{x},{lbj}\times NB+{y}&gt;
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">x</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span></span></p>
<p>如图xx所示，维度为M=7,N=7的数据矩阵A先划分为多个大小为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mo>×</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2\times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>的数据块，第6列数据块均只有一列，第6行的数据块均只有一行；数据块划分完成后，以块为基本单位，循环分配给<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">2\times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>个进程，进程负责分配到的数据的存储与计算。</p>
<figure data-type="image" tabindex="4"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/FHI-aims_Matrix-scalapack_2D.svg" alt="FHI-aims_Matrix-scalapack_2D" loading="lazy"></figure>
<p>同理，用类似一维进程数组的映射思想，也可得出二维进程网格到全局矩阵索引的映射关系：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>g</mi><mi>I</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><msub><mi>k</mi><mi>m</mi></msub><mo>×</mo><mi>M</mi><mi>B</mi><mo>+</mo><mi>x</mi></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>(</mo><mrow><mi>l</mi><mi>b</mi><mi>i</mi><mo>×</mo><msub><mi>P</mi><mi>r</mi></msub><mo>+</mo><msub><mi>p</mi><mi>r</mi></msub></mrow><mo>)</mo><mo>×</mo><mrow><mi>M</mi><mi>B</mi><mo>+</mo><mi>x</mi></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>g</mi><mi>J</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><msub><mi>k</mi><mi>n</mi></msub><mo>×</mo><mi>N</mi><mi>B</mi><mo>+</mo><mi>y</mi></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>(</mo><mrow><mi>l</mi><mi>b</mi><mi>j</mi><mo>×</mo><msub><mi>P</mi><mi>c</mi></msub><mo>+</mo><msub><mi>p</mi><mi>c</mi></msub></mrow><mo>)</mo><mo>×</mo><mrow><mi>N</mi><mi>B</mi><mo>+</mo><mi>y</mi></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
{gI} &amp;={k_m\times MB+x} \\
		&amp;=({lbi\times P_r+p_r})\times {MB+x}\\
{gJ} &amp;={k_n\times NB+y} \\
		&amp;=({lbj\times P_c+p_c})\times {NB+y}
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.7500000000000004em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span></span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-2.4099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span></span></span><span style="top:-0.9099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">x</span></span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">x</span></span></span></span><span style="top:-2.4099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span style="top:-0.9099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>k</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">{k_m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>k</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">{k_n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>分别表示当前元素在全局矩阵中的数据块的行列索引。</p>
<h3 id="ntpoly矩阵格式">NTPoly矩阵格式</h3>
<p>NTPoly用于实现DFPT中的线性标度的密度矩阵计算【参考文献xx】，传统的密度矩阵计算实现需要三次方标度，而NTPoly将密度矩阵分割为二维子矩阵乘法，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><msup><mi>N</mi><mn>2</mn></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 的进程网格并行计算 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><msup><mi>N</mi><mn>3</mn></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N^3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 的子矩阵乘法，在负载均衡的情况下，时间复杂度为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>N</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>，通过二维进程网格并行计算的方式实现了线性标度实现。</p>
<p>NTPoly的矩阵的分布方式比较朴素，假设元素矩阵维度为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">M\times N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span>，二维进程网格为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>r</mi><mo>×</mo><mi>p</mi><mi>c</mi></mrow><annotation encoding="application/x-tex">pr\times pc</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">c</span></span></span></span>，若M和N能整除进程网格总数，则整除均分子矩阵，否则将矩阵对应维度增加空白元素，直至两个维度均能整除进程网格总数。图xx将原始的矩阵分配给<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mo>×</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2\times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>的进程网格，恰好等分为4个<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mo>×</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2\times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>的子矩阵。</p>
<img src="毕业论文.assets/FHI-aims_Matrix-NTPoly_split.png" alt="FHI-aims_Matrix-NTPoly_split" style="zoom: 67%;" />
<p>在DFPT中，原始矩阵先通过二维循环块划分转换为ScaLAPACK矩阵格式进行分布式矩阵运算，然后在通过MPI_Alltoall转换为NTPoly所需要的二维进程网格划分的矩阵存储形式，进行线性标度的密度矩阵运算。计算完后再次通过MPI_Alltoall转为ScaLAPACK格式矩阵，以此迭代进行运算。</p>
<h2 id="hamiltonian矩阵计算">Hamiltonian矩阵计算</h2>
<h3 id="计算流程概述">计算流程概述</h3>
<p>图xx展示了在FHI-aims中计算Hamiltonian矩阵涉及到的矩阵变换流程。图xx.(a)表示全局Hamiltonian矩阵的逻辑视图，原矩阵数据中Aij表示非零元，0表示零元，进程分配视图表示与4个进程各自相关的矩阵元。根据进程分配视图，每个进程将这些矩阵元存储到本地的局部稠密矩阵（图xx.(b)），每个进程在各自的局部稠密矩阵上做积分求Hamiltonian矩阵元，并将最终的结果转换到本地内存上的全局稀疏矩阵CSR（图xx.(c)）。在所有进程都完成CSR格式转换后，每个进程上仅负责与自身相关的矩阵元计算，存在多个进程对一个矩阵元有计算贡献的情况，如A12，A21和A22，分别有两个进程对其有贡献。此时通过MPI_Allreduce将整体对每个矩阵元的结果累加起来，即得到一次迭代后完整的Hamiltonian值。最后再利用预先建立好的索引将以CSR存储的矩阵转换为ScaLAPACK格式存储的矩阵，进行随后相应的分布式矩阵运算。</p>
<img src="毕业论文.assets/FHI-aims_Matrix-H_overview.png" style="zoom: 50%;" />
<h3 id="内存瓶颈">内存瓶颈</h3>
<p>在Hamiltonian矩阵计算的过程中，仅仅MPI_Allreduce步骤使用到通信，其余步骤均是每个进程在本地完成的工作。从整个计算流程的内存视图来看，在局部稠密矩阵进行积分运算和ScaLAPACK进行分布式矩阵运算时，所将矩阵以分布式方式存储，其内存压力可通过增加进程数目来缓解，而以CSR格式存储全局的稀疏矩阵作为中间缓冲区降低计算难度的步骤中，每个进程都维护/存储着同样的一套行索引row_idx，列索引col_idx和内存空间大小一致的values数组，随着原子体系的增大，CSR存储需要的内存也会快速增长，即使增加再多的计算资源，也无法解决它所造成的内存瓶颈。</p>
<p>假设现在要计算15万个原子的体系，若每个原子设置两个基函数，则基函数总数至少达30万个，全局Hamiltonian矩阵的矩阵元个数为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>9</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>10</mn></msup></mrow><annotation encoding="application/x-tex">9\times 10^{10}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">9</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span>。若矩阵稀疏度是10%，矩阵元采用8byte的双精度存储，则所需的存储空间为：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>9</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>10</mn></msup><mo>×</mo><mn>8</mn><mo>×</mo><mn>10</mn><mi mathvariant="normal">%</mi></mrow><mrow><mn>1024</mn><mo>×</mo><mn>1024</mn><mo>×</mo><mn>1024</mn></mrow></mfrac><mo>=</mo><mn>67.05</mn><mi>G</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">\frac{9\times 10^{10}\times 8\times 10\%}{1024\times 1024 \times 1024}=67.05GB
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.260438em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">9</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">%</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">6</span><span class="mord">7</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mord mathdefault">G</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span></span></p>
<p>以目前神威太湖之光的计算节点配置来看，用户可用的内存空间达10GB已是接近上限，即使是不考虑FHI-aims所有其它的内存消耗，把整个计算节点的内存都用来存储CSR矩阵也是无济于事。因此，如何消除CSR带来的内存瓶颈成为FHI-aims大规模体系扩展的关键问题。</p>
<h2 id="hamiltonian-矩阵分布式存储">Hamiltonian 矩阵分布式存储</h2>
<p>在 FHI-aims 中，应用特征十分显著，它的输入是原子种类和对应的三维坐标，再加上每个原子对应的基函数，便可通过量子力学方法来模拟体系的特征。其中每类原子和基函数是一对多关系，且每个基函数是唯一属于一类原子。</p>
<h3 id="积分格点-基函数和batch划分">积分格点、基函数和Batch划分</h3>
<p>而为了更好的进行模拟，通常会在整个原子周围产生格点分布，这里存在多种格点分布方法，例如均匀的格点分布，高斯分布和原子中心的分布，在 FHI-aims 中采用的是原子中心的格点分布生成算法，格点以球面形式分布，一层一层的包裹着原子，向外扩展分布。（图格点分布）</p>
<p>可见每个原子和格点也是一对多关系，即每个格点唯一归属于一个原子。现在已知原子，基函数和格点三者之间的关系，Hamiltonian 矩阵元和它们的关系如下：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>H</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mo>∫</mo><mrow><msub><mi>ϕ</mi><mi>i</mi></msub><mi>V</mi><mo>(</mo><mi>r</mi><mo>)</mo><msub><mi>ϕ</mi><mi>j</mi></msub></mrow><mi>d</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">H_{ij}=\int{\phi_iV(r)\phi_j}dr
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.22225em;vertical-align:-0.86225em;"></span><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span></span></p>
<p>其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span> 是距离向量，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>ϕ</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\phi_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>ϕ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\phi_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 表示基函数，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span></span></span></span> 表示原子的势能。确定基函数之后，从该关系式中可以得出两个结论：</p>
<ul>
<li>Hamiltonian 矩阵是方阵，行列数量都等于基函数的总数</li>
<li>Hamiltonian 矩阵是对称矩阵，可以只存储上三角或者下三角以此来减少内存占用</li>
</ul>
<p>FHI-aims 为了能够实现任务级并行和负载均衡，使用实空间区域分解算法（RSDD[参考文献]）对格点进行 Batch 划分，其核心思想是根据空间距离，采用类似二分切割的思想，将空间距离接近的格点划分到一个 Batch 内部，Batch 也可以直观的理解成一个装下有相似属性格点的大包，之后所有计算与负载分配均以 Batch 为最小单位，而非格点。原子，格点，基函数和Batch之间的关系如图xx(a)所示，一类原子具有一个或多个独立的基函数，以原子为中心产生格点，即每个格点唯一归属一个原子，Batch由多个格点构成，对所包含的格点所属的原子会产生影响，因此与每个原子的配套基函数产生一种映射关系。</p>
<h3 id="batch-矩阵元与进程的映射">Batch、矩阵元与进程的映射</h3>
<p>Batch 通过特定的分配算法分配到进程上，该进程负责与它相关存储与计算。前文提到原子与格点存在一对多关系，而格点是 Batch 的一个元素，因此 Batch 和原子存在一对多关系，进而可以得到与 Batch 相关的基函数，最后可找到和 Batch 相关的 Hamiltonian 矩阵元。通过原子，基函数，格点，Batch，Hamiltonian 矩阵元之间的关系映射，可发现 Batch 和 Hamiltonian 矩阵元的关系，而每个进程可能分配到一个或多个的 Batch，把每个进程负责的 Batch 的对应矩阵元组成集合，即找到了每个进程要负责计算的 Hamiltonian 矩阵元。例如图xx(a)中的Batch1由Atom1和Atom2产生的积分格点组成，Atom1包含基函数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>ϕ</mi><mn>5</mn></msub></mrow><annotation encoding="application/x-tex">\phi_5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，Atom2包含基函数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>ϕ</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\phi_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>ϕ</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\phi_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，因此如图xx(b)所示，Batch1仅对矩阵元<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>H</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><mo>(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>∈</mo><mrow><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>5</mn></mrow><mo>)</mo></mrow><annotation encoding="application/x-tex">H_{ij},(i,j\in{1,2,5})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">5</span></span><span class="mclose">)</span></span></span></span>有贡献。</p>
<p>而 Hamiltonian 矩阵的分布式存储的关键就在于此，找到进程和 Hamiltonian 矩阵元的关系，然后只存储与当前进程相关的矩阵元。如图xx(c)所示，在当前进程只存储相关或对其有贡献的矩阵元，即<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>H</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><mo>(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>∈</mo><mrow><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>5</mn></mrow><mo>)</mo></mrow><annotation encoding="application/x-tex">H_{ij},(i,j\in{1,2,5})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">5</span></span><span class="mclose">)</span></span></span></span>，其余的矩阵元对当前进程而言均为透明状态，既不需要读取它，也不需要计算它。将每个进程负责的矩阵元拼接为一个稠密的方阵，该方阵同样具有对称性质，因此我们只需存储上三角或下三角。采用该存储方式只要通过增加进程数量，便可降低每个进程上的存储空间压力，从而解决 Hamiltonian 矩阵在大规模扩展的内存瓶颈。</p>
<figure data-type="image" tabindex="5"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/ICPP-local_index_storage.svg" alt="ICPP-local_index_storage" loading="lazy"></figure>
<h3 id="矩阵格式转换">矩阵格式转换</h3>
<p>Hamiltonian矩阵的积分计算完成后，需要进入下一步的矩阵运算，而FHi-aims采用ScaLAPACK实现分布式矩阵运算，所以必须将Hamiltonian的存储格式转换为ScaLAPACK支持的矩阵分布存储格式。这里采用MPI作为通信框架实现数据的交换。</p>
<h4 id="消息传递接口mpi">消息传递接口MPI</h4>
<p>MPI全称为消息传递接口（Message Passing Interface），既不是一种新语言也不是编译器规格，而是一种作为动态库/静态库来提供特定平台支持（library specification），是一种消息传递的标准规定，存在许多的实现版本，其中著名的开源实现有openmpi和mpich。在不同的超级计算机上，都会针对其特定的体系结构来实现MPI，以此来提高消息通信的效率。</p>
<p>MPI主要包含以下特性：</p>
<ul>
<li>通信子划分不同的通信域，从而保证彼此间的隔离与安全</li>
<li>内置的数据类型减少拷贝的消耗且便于异构平台执行</li>
<li>丰富多样的通信模式允许精确灵活的缓冲管理</li>
<li>扩展的集合操作便于大规模可扩展的全局通信</li>
</ul>
<p>所有的MPI程序均可由以下六个接口实现：</p>
<ul>
<li>环境初始化和结束：<code>MPI_Init</code>，<code>MPI_Finalize</code></li>
<li>获取通信域大小和当前进程的编号：<code>MPI_Comm_size</code>，<code>MPI_Comm_rank</code></li>
<li>单点发送和单点接受消息：<code>MPI_Send</code>，<code>MPI_Recv</code></li>
</ul>
<p>本文涉及的主要是两个扩展的集合接口：</p>
<ul>
<li>MPI_Allreduce：对通信域内的进程施加同种运算，例如求和，取最大值或自定义操作，并将最后的结果写回每个进程</li>
<li>MPI_Alltoallv：通信域中每个进程均可指定变长的发送的数据和接受的数据来源与缓冲，是全局任意点之间的一种通信方式</li>
</ul>
<h4 id="消息通信">消息通信</h4>
<p>FHI-aims采用CSR格式存储全局稀疏矩阵时，Hamiltonian积分运算完成后，先通过MPI_Allreduce向其施加求和累加（MPI_SUM）操作，再通过MPI转换为ScaLAPACK所需的矩阵格式。而将Hamiltonian矩阵分布式存储之后，消除了MPI_Allreduce部分，直接进入采用MPI通信来转换格式的步骤。</p>
<p>每个进程先计算出需要传递的数据和接受数据的进程号，再通过MPI_Alltoallv实现数据交换，来重新构造ScaLAPACK格式的存储格式。如图xx(a)所示，H11，H12，H21和H22分别依次存储于进程P00，P01，P10和P11上，进程P00通过计算确定了需要的数据及其所在进程，于是通过MPI_Alltoallv向P01，P10和P11取矩阵元H12，H21和H22，以此获得P00上所需的完整数据，以此类推，余下三个进程以相似的方法构造各自局部的完整矩阵。</p>
<figure data-type="image" tabindex="6"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/ICPP-localIndex_communication.svg" alt="ICPP-localIndex_communication" loading="lazy"></figure>
<p>题注：不同颜色表示对应的矩阵元属于不同的进程，(a)和(b)均以全局矩阵的逻辑视图来展示每个矩阵元所属的进程；</p>
<p>局部存储的矩阵成功转换为ScaLAPACK所需的矩阵格式后，就可进行相应的分布式矩阵运算，运算完后再重新利用MPI转换回局部存储的矩阵格式，以此迭代进行计算。</p>
<h3 id="对计算核心的影响">对计算核心的影响</h3>
<p>一阶密度和一阶Hamiltonian计算中整体矩阵变换流程相类似，DFPT采用的分布式矩阵存储，其本质是采用通信方式消除了简化运算过程的缓冲CSR数组，让每个进程上的局部稠密矩阵完成积分运算后直接通过MPI转换为ScaLAPACK支持的矩阵格式。它带来了两个优点：</p>
<ul>
<li>直接消除了CSR带来的大内存占用问题，提升程序可扩展性</li>
<li>将原有的局部稠密矩阵转为CSR，CSR进行MPI_Allreduce规约和CSR转为ScaLAPACK三个步骤简化为局部稠密矩阵与ScaLAPACK进行MPI_Alltoall通信</li>
</ul>
<h1 id="动静态负载均衡">动静态负载均衡</h1>
<p>负载均衡目的是让每个核心分配到的任务尽可能的均匀且彼此间花费的时间相近，从而减少计算核心等待空闲的时间，最终提高整体资源的利用效率。本章根据DFPT计算的特点，设计了一种动静态相结合的负载均衡算法，不仅能够有效提升各个进程负载的均匀程度，而且能够减少泊松求解器部分的计算量。</p>
<h2 id="背景介绍">背景介绍</h2>
<p>负载均衡是指给定任务和资源集合，在保证任务计算完成的前提下如何充分的提高资源的利用率。负载均衡主要由调度算法、网络拓扑和负载均衡粒度三个因素决定，其中核心是调度算法<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。对于任务属性的了解，对于设计高效的调度算法极为重要，例如任务的规模，直接影响计算时间；任务间是否存在有向无环图的依赖，直接决定并行效率；任务间是否能够独立，直接决定能否并行。调度算法主要分为两大类，静态负载均衡与动态负载均衡。</p>
<h3 id="静态负载均衡">静态负载均衡</h3>
<p>静态负载均衡算法在分配任务时并不考虑每个系统的状态，如每个计算核心的当前的负载情况和电量等，而是按照分配算法中预先定义好的规则直接进行分配。静态负载均衡算法适用于任务集合计算时间和可用资源均较为规则的情况，例如处理来自网络的 HTTP 请求。其优点在于容易实现且分配流程简单，从而能减少分配过程的计算开销；其缺点在于适用性不强，无法处理任务计算时间不规则的情况。</p>
<p><strong>Round-Robin<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></strong></p>
<p>Round-Robin 又称循环分配法，即不考虑任务的优先级，将第一个任务分配给第一个计算核心，将下一个任务分配给第二个计算核心，重复执行直至最后一个计算核心分配到任务。然后重新开始，将下个任务分配给第一个计算核心，以此循环，直至所有任务分配完毕。</p>
<p><strong>Randomized static<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></strong></p>
<p>Randomized static 是指把任务随机的分配给不同的计算核心，通常具有良好的效果。如果提前知道任务的数量，可提前计算出一个随机排列，从而获取更佳的分配效果。同时它没有必要提前获取任务或计算核心的任何信息，可以消除通信带来的开销。对于一个给定的任务集合而言，该策略的性能将随着最大任务大小的增加而下降。</p>
<h3 id="动态负载均衡">动态负载均衡</h3>
<p>动态负载均衡算法在分配任务时会考虑每个系统的状态，如每个计算核心的当前的负载情况，把一个任务从超负荷的计算核心移交给另一个轻负荷的计算核心，减少任务的响应时间<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>。动态负载均衡算法适用于任务集合计算时间、可用资源不规则的情况。它优点在于适应性强，无论计算任务的计算时间多么不规则，计算核心的状态如何演化，它都能根据当前情况作出适合的分配。其缺点在于算法设计比较复杂，可能会带来分配过程的计算开销，甚至可能会导致总体的求解时间大于使用简单分配算法的时间。</p>
<p><strong>2.2.1 Master-Worker Scheme<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup></strong></p>
<p>整个系统存在一个 Master 和多个 Worker，Master 负责将工作负载分配给 Worker。系统初始化时，所有 Worker 均处于空闲状态，需向 Master 报告当前自身状态，Master 将回应 Worker 的报告请求，并给它们分配任务。当 Master 没有任务时，将会通知 Worker 停止发送自身状态。该分配方式的优点在于十分公平，可达到一个较好的负载均衡。其缺点在于缺乏可扩展性，即随着计算节点的增加，通信消耗将会成为系统的瓶颈。</p>
<p><strong>2.2.2 Work Stealing<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup></strong></p>
<p>Work Stealing 会以随机或者一种特定的规则分配给每个计算核心一定的任务量，然后令不活跃的计算核心从活跃的或者满负载的计算核心中”偷取“任务，从而到达负载均衡的效果。该方法十分高效，但由于实现要保证不让通信占据大部分的计算时间，实现过程变得十分困难。</p>
<h2 id="整体架构">整体架构</h2>
<p>负载均衡的第一个问题在于确定负载对象的粒度和度量指标等，在DFPT中以Batch为负载的基本单位，以与Batch相关的实际运行时间为度量指标。第二个问题在于选择合适的负载方法，动态负载均衡分配的效果好，适用性强，因此在DFPT中倾向使用动态负载均衡。但动态负载均衡每次重新收集负载信息，计算分布与通信分配都会引入额外开销。在DFPT中，可将其计算流程简单抽象为多次迭代，每次迭代中与Batch相关的计算时间比较接近，因此此可大致得出每次迭代的负载分布均一致的结论，我们只需在首次进行动态负载均衡计算，其余迭代均采用静态负载均衡思想，即复用首次计算而来的新负载分布，从而有效的减少额外计算开销。这种动静态相结合的负载均衡算法充分地利用了DFPT的计算特征，在动态和静态负载间做了一个有效折衷，从而有效提升负载程度与效率。</p>
<figure data-type="image" tabindex="7"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/ICPP-loadBalancing_overview.svg" alt="ICPP-loadBalancing_overview" loading="lazy"></figure>
<p>动静态负载均衡的整体框架如图xx所示，根据迭代次数执行不同的操作，迭代次数为1时，需要收集与Batch相关的运行时间，作为后续新分布计算的依据。收集完所有的负载时间后，加之每个Batch的位置信息，计算一种同进程上负载时间尽可能接近且Batch位置尽可能相邻的新分布。最后在通过MPI完成任务的重新分配；迭代次数不为1时，为了保证接口的一致性和最小代码改动原则，直接使用首次计算得到的新分布，并对输出的数组先进行置换重排与新分布保持一致，等正常计算的流程结束，再通过置换重排将输出的数组置换重排还原为与原始分布一致的状态。第一次迭代是动态负载均衡，余后迭代均沿用首次计算的分布，即每次都提前知道分布方式的静态负载均衡，这样能充分利用并结合动态负载均衡的良好负载效果和静态负载均衡的低计算开销的优点。</p>
<h2 id="负载分布的计算">负载分布的计算</h2>
<p>算法伪代码xx中展示了负载分布计算的核心思想，用二分法的思想去进行置换重排，在输入的Batches描述符中，权重直接使用每个Batch在首次计算的运行总时间，三维坐标是通过求Batch内部所有格点坐标的几何中心而来。在算法中用get_idim函数来获取距离最远距离的那个分量/维度，便于简化后续具体划分时的复杂度，不使用指定维度，意味这idim每次的结果都可能发生变化，从而保证三维空间内每个维度的距离都会被划分时考虑到。</p>
<pre><code class="language-pseudocode">输入:
    bd: Batches描述符, bd(i).{x,y,z,w,id}分别表示第i个batch的三维笛卡尔坐标,权重和编号
    Ta,Tb: 等待任务分配的起止MPI任务编号
    MYID: 当前MPI任务编号
    off,len: 表示bd(off:off+len)属于编号为MYID的MPI任务
    get_idim(bd): 获取在bd(off:off+len)中拥有最远距离的维度
    divide_values(bd,idim,Wam,mid):使用类似快速排序算法的思想完成值的置换重排，令其满足以下两个目标:
    (1)$\sum{{bd(off:mid).w}} \approx {Wam}$;
    (2)$\forall x \in {bd(off:mid).idim}, \nexists y \in {bd(mid+1:off+len).idim}, x&gt;y$
输出:
	bd: 重新排列后的Batches描述符

function distribute_batches(bd,Ta,Tb,off,len):
    if (Ta != Tb):
        return 
    Tm = (Ta+Tb-1)/2
    $Wam = \sum_{i=Ta}^{Tm}bd(i).w$
    idim = get_idim(bd)
    CALL divide_values(bd(off:off+len),idim,Wam,mid)

    if (MYID &lt; Tm):
        len = mid
        CALL distribute_bathches(bd,Ta,Tm,off,len)
    else
        off = off+mid
        len = len-mid
        CALL distribute_bathches(bd,Ta,Tm,off,len)

function get_idim(bd):
	max_dist = -1
	max_dim  = -1
	for dim in {x,y,z}:
		dist = MAX{bd.dim} - MIN{bd.dim}
		if (max_dist &lt; dist):
			max_dist = dist
			max_dim = dim
	return max_dim
</code></pre>
<p>这里简单介绍下divide_values的核心思想，类似于快速排序思想，它选择不同的基作为划分，逐步进行划分，再逼近的思想。先满足位置要求，在满足权重要求。</p>
<p>（1）位置要求：先用 quicksort 思想进行排序，指定一个基准，令左侧均小于它，右侧均大于它。</p>
<p>（2）权重要求：</p>
<ul>
<li>若左侧权重还小于目标权重，则左侧满足条件，继续向右侧划分是为了能够更优化目标，即更加接近目标；（足够小，从左侧接近目标）</li>
<li>若左侧权重大于目标权重，则右侧满足条件，即把划分区间向左侧收缩。（足够大，从右侧接近目标）</li>
</ul>
<h2 id="置换重排">置换重排</h2>
<p>为了尽可能的保持和FHI-aims原有接口的兼容性，只对相应计算核心内部进行置换重排从而实现负载均衡。图xx展示了置换重排的大致思路，假设系统中存在P0到P2三个进程，B1到B7七个Batch，为了简化，假设编号相近表示Batch距离相近，并且每个Batch的权重相同。初始分布中三个进程分别负责4，3和2个Batch的计算，可见其负载不够均匀，由于首次运行时已计算出负载较为均衡的新分布，因此进程间通过MPI_Alltoallv即可完成新分布的具体分配。使用新分布在具体的计算核心内完成相应运算后，在通过MPI_Alltoallv将分布还原为初始状态，以此完成一次负载均衡的计算。</p>
<img src="毕业论文.assets/FHI-aims_Matrix-localBalancing_permute.png" style="zoom:50%;" />
<h2 id="对泊松求解器的影响">对泊松求解器的影响</h2>
<p>泊松求解器中有一个热点函数用于计算delta_v_hartree的积分，它在泊松求解器的时间占用从5%~20%不等。其伪代码如图xx所示，位于三层循环内部，若当前的spline不等于上一次的spline，则需要重新进行计算。而本章的动静态负载均衡不仅考虑了时间的均匀分布，还将Batch的空间三维坐标中距离小的优先分配到一个进程上，因此同一个进程上Batch的空间距离会尽可能的解决，所以通过map_fun映射之后，同一个进程上相邻的i_center被映射到同一个spline的概率会变大，从而减少delta_v_hartree的重复计算，以此降低计算开销。</p>
<pre><code class="language-pseudocode">old_spl_atom = -1 // 上一次spline编号
for i_center in (1,n_center):
	cur_spl_atom = map_fun(i_center) // 映射函数
	for i_batch in (1,n_my_batches):
		for i_index in (1,batch_size):
			if (cur_spl_atom != old_spl_atom): // 是否命中缓存？
				integrate_delta_v_hartree() // 计算核心
				old_spl_atom = cur_spl_atom
</code></pre>
<p>该方法与缓存Cache的思想不谋而合，只不过这里为了节约内存空间，只缓存上一次的结果，但通过对Batch的位置重分配，大大提高同一个进程上Batch的相邻程度，从而提高缓存命中率。</p>
<h1 id="神威平台优化">神威平台优化</h1>
<p>本章主要讨论DFPT模块中一个重要部分泊松求解器在神威太湖之光上的优化。优化内容主要包括定位核心热点函数，将计算核心代码从Fortran翻译为C语言等前置准备工作；多级并行策略的实现，即进程间的MPI并行，线程级的athread并行，数据级的simd并行；通过DMA和tiling等手段实现的访存优化。</p>
<h2 id="前置准备">前置准备</h2>
<h3 id="热点定位">热点定位</h3>
<p>在程序优化中热点指耗时占程序运行总时间较多的部分，可以是一个函数，也可以是一个代码片段，如多重循环等，也常常称之为kernel。定位热点是程序优化中必不可少的一个环节，无论是刚拿到一个待优化的应用，还是已在优化过程中，都需要先找到程序的热点，再由针对性的花精力去优化它。二八定律在程序优化中普遍存在，即20%的代码片段耗费整体80%的时间，在工程开发阶段，能够投入的人力和资源都是有限的，若想充分利用人力和物力，就需要将精力用在刀刃上，即专注于热点函数的优化，能够在短时间内带来整体的最大收益。</p>
<p>常见的热点定位方法有两种，即手动插时间桩或借助性能分析工具。手动插桩需先确定要使用的计时方法，可以用系统提供的时间统计接口或者使用CPU的时钟周期。在并行程序中，比较常用的手段是使用MPI提供的MPI_wtime接口或者系统中提供的时钟周期的拍数获取接口。借助性能分析工具，例如GNU套件中的gprof，可以很好的对程序整体进行性能测试，用该工具的好处在于无需改变源代码，只要在编译和链接时加上指定的选项，即可得到对应的性能分析结果，但坏处在于它会在一定程度上影响程序的性能。手动插桩结果虽然较准确，但实现起来略麻烦，特别是在并行程序中，还需要手动处理好写时间时的并行冲突问题。</p>
<p>伪代码xx展示了在神威上使用插桩法统计时间的基本模式，为了提高效率，用宏定义与嵌入式汇编获取时钟周期数，在计算kernel的前后分别记录时钟周期，二者相减则得到计算kernel的总周期数/拍数，将其除以计算核心的主频则可获得以秒为单位的时间。</p>
<pre><code class="language-C">#define SLAVE_RPCC(x) asm volatile (&quot;rcsr %0,4&quot;:&quot;=r&quot; (x)::&quot;memory&quot;);
int main()
{
	SLAVE_RPCC(start_rpcc);	// 获取CPU时钟拍数
    cal_func(); // 计算kernel
    SLAVE_RPCC(end_rpcc);	// 获取CPU时钟拍数
    cal_time = end_rpcc - start_rpcc;	// kernel占据的拍数
}
</code></pre>
<p>利用gprof程序分析整个DFPT模块，发现泊松求解器部分占了80%左右的时间，可以称之为超级热点。再对泊松求解器进行性能探测，发现其内部的时间分布十分零散，并不存在很集中的热点函数。但通过仔细的分析发现它内部由一个多重循环组成，所有零散的函数基本落在该循环内部，此时把这个多重循环看个一个整体，将占泊松求解器的90%以上的耗时，于是我们将最终的优化的直接目标锁定在这个多重循环上。</p>
<p>在神威上使用gprof需要在编译时加上“-pg”选项，在作业提交上加上参数“-sw3runarg &quot;-P slave&quot;”，作业执行完毕后，会生成形如“gmon.out”的记录文件，在命令行键入：</p>
<pre><code>gprof 可执行文件 gmon.out &gt; prof.out
</code></pre>
<p>即可将性能探测信息重定向至文件prof.out。针对泊松求解器的从核性能分析的部分输出结果如图xx所示，该输出分为四列，”name“表示对应的函数名，“%time”表示该函数所占用的时间百分比，从高到低进行排序显示，”self seconds“表示该函数消耗的总时间，”cumulative seconds“表示当前及其上方的函数执行时间总和。一般我们从上往下看函数名称的顺序，也是热点优化的优先顺序，时间占比越高越先优化。</p>
<pre><code>Each sample counts as 0.01 seconds.                                                                                                                    
  %   cumulative   self              
 time   seconds   seconds    name    
 32.43   6511.58  6511.58    slave_far_distance_real_hartree_potential_single_atom_p2_c_
 21.64  10856.69  4345.11    slave_sum_up_i_batch_loop1_c_
 16.34  14137.29  3280.59    slave_integrate_delta_v_hartree_internal_c_
  9.16  15977.10  1839.81    slave_memset
  6.35  17252.38  1275.28    slave_cubic_spline_v2_c_
  5.31  18318.14  1065.76    slave_far_distance_hartree_fp_cluster_single_atom_p2_c_
  4.80  19281.08   962.94    slave__Waiting_For_Task
  1.78  19638.75   357.67    slave_spline_vector_v2_c_
  0.78  19795.72   156.97    slave_spline_angular_integral_log_c_
  0.74  19944.84   149.12    slave_exp
  0.23  19990.28    45.44    slave_integrate_first_order_rho_dielectric_c_
  0.15  20020.78    30.50    slave_get_rho_multipole_spl_c_
</code></pre>
<p>前文描述的热点定位本质上是一个自顶向下，逐层分解的过程。以程序的执行控制流为线索，先确定顶热点所处的大致范围，然后逐层深入并细化，追踪定位到最底层的实现代码块或函数。另一种思路则是自底向上，从最底层，最基础，被调用次数多，基本没有调用其它函数的函数，该方法适合对代码十分熟悉的人使用，或者直接利用现有的性能测试工具来完成，否则仅仅依靠人力是十分复杂的。自底向上的好处在于能分析清楚整个程序中最重要的支柱是哪几个基础函数，集中精力优化这些函数就能达到很好的效果。当我们对程序不熟悉时，或者在平台上缺乏对应的性能分析工具，只能用插桩法时，自顶向下是一个高效且实用的思路。</p>
<h3 id="fortran转c语言">Fortran转C语言</h3>
<p>DFPT部分完全用适合数值计算的Fortran语言实现，但为了能够在神威太湖之光的异构加速器上更好的进行优化，决定将泊松求解器部分的代码全部翻译为C语言，让Fortran直接调用C语言实现的等价函数，二者进行混合编译生成可执行文件。</p>
<p>将泊松求解器转为C语言实现工作量巨大，首先得十分了解C语言和Fortran的特性，才能顺利完成二者的转换。其次要保证正确性，需要注意诸多可能导致bug或精度损失的细节问题。最后尽可能的提升转换后的代码效率。这里简单介绍C语言和Fortran混合编程的知识，二者的特性对比总结见表xx：</p>
<table>
<thead>
<tr>
<th>对比项目</th>
<th>Fortran</th>
<th>C</th>
</tr>
</thead>
<tbody>
<tr>
<td>编译器命名函数</td>
<td>全转小写，加后缀”_“</td>
<td>保留原函数名，区分大小写</td>
</tr>
<tr>
<td>数组内存视图</td>
<td>列顺序优先存储（靠左下标变化快）</td>
<td>行顺序优先存储（靠右下标变化快）</td>
</tr>
<tr>
<td>数组索引起点</td>
<td>1 开始</td>
<td>0 开始</td>
</tr>
<tr>
<td>函数参数传递</td>
<td>引用（传址）</td>
<td>传值/传址</td>
</tr>
</tbody>
</table>
<p><strong>函数命名</strong>：不同的编译器在编译时会对函数名做一些处理，C语言的GCC编译器不对函数名做改变，C++的编译器为了支持多态等特性会对函数名进行复杂的命名变换，Fortran90的编译器会在其函数名后加上后缀下划线”_“，例如源文件中函数名为”foo“，编译之后变为”foo_“。因此若想编写能被Fortran调用的C函数，则需要在函数名后增加后缀下划线，在Fortran程序中调用未加下划线的函数名。</p>
<p><strong>函数参数传递</strong>：在Fortran的函数调用中，参数默认是传递地址，没有传值的选项，而C语言则支持传值和传值（指针）。因此在编写给Fortran调用的函数时，注意要将所有的形参全声明为指针类型，以此匹配兼容Fortran引用传参的特性。大多数情况下以指针方式传递数组会减轻栈空间的压力，避免反复压栈和弹栈，可以一定程度上提高程序效率。</p>
<p><strong>数组内存视图</strong>：在日常编程中，数组是用途最广泛的数据结构。在高维数组中，为人所熟知的C语言是按行优先来存储数据的（靠右侧的索引变化快）；而Fortran却是按列优先来存储数据（靠左侧的索引变化快）。例如现存在n维的数组<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mi>r</mi><mi>r</mi><mo>(</mo><msub><mi>d</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>d</mi><mi>n</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">{Arr(d_1,d_2,...,d_n)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，对于C语言，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>d</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">{d_n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>维索引先变化，而Fortran是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>d</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">{d_1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>维索引先变化。根据语言的内存存储特征，去设计相对应的高效数据访问模式对于高性能程序来说至关重要。在将Fortran转换为C语言过程中，最容易忽略的细节就是以Fortran内存模式存储数组，却以C语言内存模式来访问数组，造成诸多的不连续访问，导致数据Cache利用率急剧下降。</p>
<p><strong>数组索引起点</strong>：C语言中数组的索引都默认从0开始，而Fortran默认是从1开始的，同时Fortran还支持变长数组，可以指定任意的整数为数组索引的起止点，包括负数，这是为科学计算设计的便捷特性。该细节也常常导致一些段错误或者难以察觉的精度损失问题。</p>
<h2 id="三级并行策略">三级并行策略</h2>
<h3 id="并行设计概览">并行设计概览</h3>
<p>图xx展示了FHI-aims在神威上的三级并行策略。将三维积分格点划分为Batch集合（图xx(a)），并分配给MPI进程（图xx.(b)），每个MPI进程占用一个核组。在每个核组内部，主核负责逻辑控制，64个从核负责计算主核分配而来的任务（图xx.(c)）。在每个从核上，可对数据连续存放的运算密集型的操作进行单指令多数据流的指令集并行实现加速。</p>
<figure data-type="image" tabindex="8"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/image-20210519145143686.png" alt="image-20210519145143686" loading="lazy"></figure>
<h3 id="athread并行划分算法设计">Athread并行划分算法设计</h3>
<p>Athread并行划分中也是以Batch为单位，最开始使用的是Round-Robin划分，分配公式</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>v</mi><msub><mi>e</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub><mo>=</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub><mo separator="true">,</mo><mn>64</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">slave_{id}=MOD(Batch_{id},64)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mclose">)</span></span></span></span></span></p>
<p>式中：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>v</mi><msub><mi>e</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">slave_{id}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为从核编号，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Batch_{id}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为Batch的编号，64是一个核组内从核的总数。该分配方式十分简单且有不错的效果，适合最初步的并行划分。</p>
<p>随着负载均衡算法的实现，一个进程上所分配到的Batch在空间上会尽可能相邻，这个特性正好与Round-Robin划分相矛盾，导致一个Athread上分到的Batch并不具有连续性，因此改变划分算法为</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>R</mi><mo>=</mo><mi>M</mi><mi>O</mi><mi>D</mi><mo>(</mo><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mi>N</mi></msub><mo separator="true">,</mo><mn>64</mn><mo>)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>N</mi><mo>=</mo><mfrac><mrow><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mi>N</mi></msub></mrow><mn>64</mn></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>v</mi><msub><mi>e</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mfrac><mrow><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub></mrow><mrow><mi>N</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mo separator="true">,</mo><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub><mo>≤</mo><mi>N</mi><mo>×</mo><mi>R</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mfrac><mrow><mo>(</mo><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub><mo>−</mo><mi>N</mi><mo>×</mo><mi>R</mi><mo>)</mo></mrow><mrow><mi>N</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mo>+</mo><mi>R</mi><mo separator="true">,</mo><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mrow><mi>i</mi><mi>d</mi></mrow></msub><mo>&gt;</mo><mi>N</mi><mo>×</mo><mi>R</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
&amp;R=MOD(Batch_N,64)\\
&amp;N=\frac{Batch_N}{64}\\
&amp;slave_{id}=
\begin{cases}
	\frac{Batch_{id}}{N+1},Batch_{id}\le N\times R\\
	\frac{(Batch_{id}-N\times R)}{N+1}+R, Batch_{id} &gt; N\times R
\end{cases}
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.15747em;vertical-align:-3.3287350000000004em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.828735em;"><span style="top:-6.738735em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"></span></span><span style="top:-4.707294999999999em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"></span></span><span style="top:-1.9712949999999996em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3287350000000004em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.828735em;"><span style="top:-6.738735em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mclose">)</span></span></span><span style="top:-4.707294999999999em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.9712949999999996em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6909999999999998em;"><span style="top:-3.6929999999999996em;"><span class="pstrut" style="height:3.01em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9019679999999999em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.41586em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">c</span><span class="mord mtight"><span class="mord mathdefault mtight">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.403331em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span><span style="top:-2.2509999999999994em;"><span class="pstrut" style="height:3.01em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">c</span><span class="mord mtight"><span class="mord mathdefault mtight">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.403331em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1910000000000003em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3287350000000004em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>式中：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi><mi>a</mi><mi>t</mi><mi>c</mi><msub><mi>h</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">Batch_N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为当前MPI进程上的Batch总个数。通过该划分算法可以保证每个从核分配到的Batch一定是连续的，并且线程间最大和最小Batch数量差值不超过1，从而保证负载较为均匀。</p>
<h3 id="simd指令集并行">SIMD指令集并行</h3>
<p>采用SIMD指令时，一条指令可以同时处理多个数据，从而减少运算指令的数量。神威太湖之光上从核支持的指令长度为256B，所以可以支持8个int类型或4个double类型。</p>
<p>SIMD在编程时，若数据个数不能正好被SIMD所支持的类型整除，则末尾剩余的数据需要使用标量进行计算。对于向量部分，则通常需要四个步骤进行运算，如清单xx所示，定义扩展类型后，需将标准类型转为扩展类型，再进行扩展类型所支持的运算，最后再将扩展类型转换为标准类型，继续正常的标量运算。</p>
<pre><code class="language-c">#define SIMD_DV_SIZE 4
int i;                      
for (i = 0; i &lt;= (inner_size - SIMD_DV_SIZE); i += SIMD_DV_SIZE){
    // 1. 定义doublev4的扩展类型
    doublev4 dv4_spl_param[4], dv4_res;
    // 2. 数据转换：标准数据类型转换为扩展数据类型
    simd_load(dv4_spl_param[0], &amp;ldm_spl_param[0][i]);
    simd_load(dv4_spl_param[1], &amp;ldm_spl_param[1][i]);
    simd_load(dv4_spl_param[2], &amp;ldm_spl_param[2][i]);
    simd_load(dv4_spl_param[3], &amp;ldm_spl_param[3][i]);

    // 3. 数据运算：扩展运算符，每个分量均与标量进行乘法
    dv4_res = dv4_spl_param[0]
        + dv4_spl_param[1] * t 
        + dv4_spl_param[2] * t2
        + dv4_spl_param[3] * t3; 
	// 4. 数据转换：扩展数据类型转为标准数据类型
    simd_store(dv4_res, &amp;out_result[i]);
}   
// 不足4个double类型的末尾部分
for ( ; i &lt; inner_size; i ++){                                                   
    out_result[curBgn + i] = ldm_spl_param[0][i]
        + ldm_spl_param[1][i] * t
        + ldm_spl_param[2][i] * t2
        + ldm_spl_param[3][i] * t3;
}
</code></pre>
<p>SIMD在进行优化时，若所有运算均充分利用其特性，最高性能可达SIMD一次能操作的数据个数，如intv8相关指令运算，满负荷下能提高8倍速度，doublev4则能提高4倍速度。合理灵活的使用对应的指令能降低系统对指令带宽的负载，从而能利用更多的带宽。</p>
<h2 id="访存优化">访存优化</h2>
<p>针对神威计算核心的体系结构做相应的访存优化，尽量减少数据访问和移动，提高从核LDM的利用率。</p>
<h3 id="简单-dma">简单 DMA</h3>
<p>DMA是以数据为中心的优化方式，必须要先把数据流，控制流都了解清楚，才好进行优化。可以先对数据变量进行分类：</p>
<ul>
<li>单变量（非数组）：若已在LDM则不管，若不在LDM，可以直接在LDM的栈上申请一个同类型的变量来减少对主存的访问次数</li>
<li>定长数组：数组长度已知或能预估出数组长度上限，且长度不大，可直接在LDM开辟静态数组</li>
<li>变长数组：只有运行时才能确定数组大小，根据访问的频率和是否为离散访存来决定DMA方式。访问频率越高，是该数组的部分数据驻留在LDM上可提升效率。若是离散访存，可以考虑先计算出部分索引表，再进行DMA取存数据</li>
</ul>
<p>除了以上的分类数据外，根据控制流来分析数据流中是否存在无用的数据，例如某些数据算出来根本没有进行读写，这些数据可以直接删除。也可以适当的进行合并和拆分数据结构，提高LDM利用率。</p>
<p>简单DMA只能处理一些简单变量和数组，优化效果并不会很明显，但是也很有必要去做它，可已增加对程序数据的理解程度。</p>
<h3 id="loop-tiling">Loop Tiling</h3>
<p>在程序中最常见的莫过于循环结构，特别是处理数组时，循环更是必不可少的操作。而针对变长数组，且数组长度无法一次性在LDM放下时，分块处理/loop tiling变为首选。</p>
<h4 id="tiling介绍">tiling介绍</h4>
<p>所谓 tiling，本质是分块计算/访存。因为神威体系中，内存分为主存和从核上的局部存储LDM(Local Device Memory)，每次直接访问主存称为 gld/gst，将带来较大的消耗，而通过 DMA 将主存数据读到 LDM 上，之后直接访问 LDM（称为 ld/st），将减少时钟周期数。LDM 在 sw5 上是 64KB，合理的分配与使用才能发挥其最大的功效。每次 DMA 的大小为 128 的倍数效果最佳。</p>
<p>单层循环是最简单的 tiling 情况，固定块大小，即可实现。后续可扩展到二层循环，此时需要考虑在哪一层做tiling，完全静态还是动态，若完全静态，需根据经验分配到具体的层数，看看需要的内存是否都已经满足；若是动态，则从最外层开始计算，看看能容下第几层开始的 tiling。</p>
<p>以上都是不考虑循环内部包含函数调用的情形，若最内层还有函数调用，则需确定一个一致性原则，到底是进去还是不进去，即直接在外层控制传入参数，函数内部则不处理；或者是外层不做改动，在函数内部再仔细优化。一般情况下，若函数依赖性很强，只能用第一种方法来做适应性改动。</p>
<h4 id="tiling-编程框架">tiling 编程框架</h4>
<p>假设数组大小为 N，块大小为 M，示例分析如下：</p>
<ul>
<li>原程序：N 次 gst</li>
<li>优化后：upper(N/M) 次 DMA _put + N 次 st</li>
<li>理论上来说，当 M=N 时，能够取得最好的效果。一般情况下 LDM 不够用，都是开 1024B。</li>
</ul>
<pre><code class="language-c">#define ARRSIZE 19
#define TILESIZE 9

/* In byte memory view: mem[0..len-1] = ldm[0..len-1] */
void pe_put(char *mem, char *ldm, size_t len)
{
    for (int i = 0; i &lt; len; i++)
        mem[i] = ldm[i];
}

int main()
{
    // simulate host memory
    int arr[ARRSIZE] = {0};

    /* origin loop */
    //for (int i = 0; i &lt; ARRSIZE; i++) {
    //    arr[i] = i;
    //}

    /* tiling loop mode */
    // simulate local device memory(LDM)
    int tmp[TILESIZE] = {0};
    int inner_size = TILESIZE;

    for (int curBgn = 0; curBgn &lt; ARRSIZE; curBgn += inner_size) {
        // get adjust inner loop size
        inner_size = (curBgn + TILESIZE &gt;= ARRSIZE) ? ARRSIZE - curBgn : TILESIZE;

        for (int i = 0; i &lt; inner_size; i++) {
            tmp[i] = curBgn + i;
        }
        // from LDM write back to host memory(gld)
        pe_put((char*)&amp;arr[curBgn], (char*)tmp, sizeof(int) * inner_size);
    }
	return 0;
}
</code></pre>
<p>总结一下改造一重循环为tiling的框架，需先增加必要的4个变量：</p>
<ul>
<li>局部内存：
<ul>
<li><code>TILESIZE</code>：需要开辟的局部存储的大小</li>
<li><code>tmp[TILESIZE]</code>：局部数组</li>
</ul>
</li>
<li>内层循环：
<ul>
<li><code>curBgn</code>：记录此刻对应的原数组的下标</li>
<li><code>inner_size</code>：内层循环的大小</li>
</ul>
</li>
</ul>
<p>再对循环内存适当改造，同时再内存循环开始和结束处适当加以 <code>dma_get</code> 或 <code>dma_put</code>。</p>
<h3 id="计算通信隐藏">计算通信隐藏</h3>
<p>计算通信隐藏即充分利用带宽和计算能力，在通信的同时还进行着运算，这也算是一种并行。在本章中常用的计算通信隐藏的模式如图xx所示，假设通过DMA取存数据所需的通信时间为C，无依赖计算时间为K，则原有的串行计算时间为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo>+</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">C+K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span>，计算通信并行后，总时间为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>A</mi><mi>X</mi><mo>{</mo><mi>C</mi><mo separator="true">,</mo><mi>K</mi><mo>}</mo></mrow><annotation encoding="application/x-tex">MAX\{C,K\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mopen">{</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">}</span></span></span></span>，加速比为：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">加</mi><mi mathvariant="normal">速</mi><mi mathvariant="normal">比</mi><mo>=</mo><mfrac><mrow><mi>C</mi><mo>+</mo><mi>K</mi></mrow><mrow><mi>M</mi><mi>A</mi><mi>X</mi><mo>{</mo><mi>C</mi><mo separator="true">,</mo><mi>K</mi><mo>}</mo></mrow></mfrac><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>1</mn><mo>+</mo><mfrac><mi>K</mi><mi>C</mi></mfrac><mo separator="true">,</mo><mi>C</mi><mo>&gt;</mo><mi>K</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>1</mn><mo>+</mo><mfrac><mi>C</mi><mi>K</mi></mfrac><mo separator="true">,</mo><mi>C</mi><mo>≤</mo><mi>K</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">加速比=\frac{C+K}{MAX\{C,K\}}=\begin{cases}
=1+\frac{K}{C},C&gt;K\\
=1+\frac{C}{K},C\le K\\
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mord cjk_fallback">加</span><span class="mord cjk_fallback">速</span><span class="mord cjk_fallback">比</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.29633em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mopen">{</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">}</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>当C=K时，加速比取最大值2，可见C和K越接近，加速的效果越好。即尽可能的平衡通信和计算之间的关系，以求最大化利用通信带宽与计算能力。</p>
<pre><code class="language-C">// 使用异步DMA从主存读、写数据
pe_get(host_arr1, host_arr2, ..., host_arrn)
pe_put(arr)
// 进入与通过DMA读/写的数据无依赖关系的计算核心
independent_kernel()
// 在需要DMA的数据之前才进行同步，等待DMA结束
dma_syn()
// 依赖DMA读/写的数据的计算核心
depedent_kernel()
</code></pre>
<h1 id="实验结果">实验结果</h1>
<h2 id="精度验证">精度验证</h2>
<p>图xx展示使用线性标度算法NTPoly求解密度矩阵的最终精度随着参数n_filter的选取结果的变化，其中测试用例选择包含386个原子的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi><mo>(</mo><mi>C</mi><mn>2</mn><mi>H</mi><mn>4</mn><msub><mo>)</mo><mi>n</mi></msub><mi>H</mi></mrow><annotation encoding="application/x-tex">H(C2H4)_nH</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord">4</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span>体系，设置参数n_tol=10，def0=12。从<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>9</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-9}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span>~<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>12</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-12}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>选取n_filter，可以看出极化率xx的绝对误差随着n_filter的减小而下降并越来越接近0。因为n_filter表示过滤元素的阈值，即小于n_filter的元素会被当初零元处理，所以n_filter越小，意味着矩阵非零元素越多，结果也越精确。</p>
<figure data-type="image" tabindex="9"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/image-20210512182500641.png" alt="image-20210512182500641" loading="lazy"></figure>
<h2 id="性能结果">性能结果</h2>
<p>本节的测试体系使用包含3006个原子的受体结合位点蛋白质（RBD），同时使用轻量级设置和局部密度近似泛函（LDA）。</p>
<h3 id="hamiltonian矩阵分布式存储">Hamiltonian矩阵分布式存储</h3>
<p>图xx为Hamiltonian矩阵元在单进程上的个数统计，采用RBD-mini测试用例，mini表示采用最小的基组集合。针对原始的全局稀疏矩阵存储CSR和分布式存储（localIndex）后的程序，分别在64到512进程下进行测试。其中localIndex_MIN和localIndex_MAX分别表示分布式存储中单进程上最小和最大的矩阵元个数。</p>
<p>CSR中可发现它需要存储的矩阵元个数恒定为2,671,636，并不随着进程数的增加而变化，因为它总是存储全局的稀疏矩阵，只要测试体系确定，则矩阵规模随之确定。因此CSR随着体系的增大会带来内存的瓶颈。而采用了分布式矩阵存储策略后，当采用64个进程运行时，单进程上最大的内存占用仅约为CSR的11.7%，随着进程数量的增加，单进程最大内存消耗不断下降，进程数为512时，最大进程内存占用仅为CSR的4.2%。从测试结果可见分布式内存带来的良好内存节约效果，从而解决一阶Hamiltonian计算和一阶密度计算中的内存瓶颈问题。</p>
<figure data-type="image" tabindex="10"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/image-20210514224559090.png" alt="image-20210514224559090" loading="lazy"></figure>
<p>同时可以看出采用分布式矩阵存储策略后，单进程上的最大和最小内存占用间存在5到15倍的差异，足以说明其负载不均的状况，这也为负载均衡算法的改进提出了新的要求。</p>
<h3 id="负载均衡">负载均衡</h3>
<p>图xx为负载均衡对泊松求解器（Potential）的改进对比图。采用RBD测试用例，用512个进程分别执行未做优化，增加分布式内存存储（localIndex）与负载均衡（loadBalacing）的FHI-aims版本。其中加了elapsed的图例表示实际执行时间（包含等待其它进程的时间），未加elapsed的图例表示CPU的执行时间。</p>
<img src="毕业论文.assets/Folder1-Graph5.png" style="zoom: 50%;" />
<p>从图中可以看出，两个版本的程序负载均衡情况都不错，每个进程上的执行时间相差不大，但是做了负载均衡的程序在实际执行时间上明显优于原版程序，这主要是由前文讨论过的负载均衡让同一进程上的Batch的位置尽可能相临近，用类似Cache缓存的思想，增加delta_v_hartree的命中率，从而减少重复的计算量。这也是为何在设计负载均衡算法时，让其先满足位置相邻的要求，再满足执行时间相近的条件。</p>
<h3 id="神威优化">神威优化</h3>
<p>图xx为神威优化的整体效果图。采用RBD测试用例，用512个进程执行。每个进程配置一个核组，核组中64个从核均充分使用。源程序为主核版本的程序，采用DMA，SIMD的程序均为从核优化。使用DMA优化使泊松求解器整体加速比为2.72，因为它通过将主存内存分块读入局存LDM从而降低了内存访问的时间。在DMA基础上，继续增加SIMD优化，整体加速比达到3.06，因为SIMD使用的条件比较苛刻，所以对整体的加速没有DMA明显。因为泊松求解器代码结构十分负载，热点分散，所以目前优化还只是初级阶段，后续可以做更为细致的优化从而挖掘其性能。</p>
<figure data-type="image" tabindex="11"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/image-20210519164455397.png" alt="image-20210519164455397" loading="lazy"></figure>
<h2 id="可扩展性">可扩展性</h2>
<p>图xx展示了FHI-aims加上分布式存储内存和负载均衡两大优化后的强扩展测试结果。其中测试体系使用五种不同规模的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi><mo>(</mo><mi>C</mi><mn>2</mn><mi>H</mi><mn>4</mn><msub><mo>)</mo><mi>n</mi></msub><mi>H</mi></mrow><annotation encoding="application/x-tex">H(C2H4)_nH</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord">4</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span>，并采用FHI-aims中的轻量级基组和局部密度近似泛函（LDA）的配置。该测试对10,000到150,000个原子进行分别进行大规模可扩展性测试，为节约资源，不同规模的测试体系使用不同的进程规模进行测试，例如100,00原子体系分别采用1,250、2,500、5,000、10,000和12500个进程完成测试，而30,000原子体系则采用从2,500到25,000间的进程数量完成测试。</p>
<figure data-type="image" tabindex="12"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/image-20210512001831392.png" alt="image-20210512001831392" loading="lazy"></figure>
<p>图xx展示了图xx对应的并行效率，五种测试体系的并行效率均随着测试进程的增加而下降，主要是因为测试体系的总格点数固定（Batch总数量固定），随着进程数量增多则导致每个进程分配到的Batch数量下降，即每个进程的负载下降，而进程间的通信量会上升，所以导致并行效率的下降。其中10,000原子到60,000原子的并行效率基本在60%以上，而110,000原子在测试进程从40,000增加到80,000进程时并行效率从69.01%下降至45.87%，说明使用80,000进程测试已经接近并行极限，再增加进程只是浪费资源，这也是为何没有对110,000原子继续增加进程测试其可扩展性的原因。</p>
<figure data-type="image" tabindex="13"><img src="%E6%AF%95%E4%B8%9A%E8%AE%BA%E6%96%87.assets/image-20210512001847736.png" alt="image-20210512001847736" loading="lazy"></figure>
<p>在本章可扩展性测试中，最大的测试体系已达150,000原子，充分展示了分布式矩阵存储的效果。而理论上实现分布式内存存储应该可达百万原子级别的测试体系，而我们进行220,000原子时就发生了错误，经过排查，发现DFPT的泊松求解器中存在多个规模与原子个数成一定比例的数组，用于存储泊松求解器所需的整个体系的原子相关数据，同时这些数组作为参数直接被传递给对应例程进行处理，还会导致栈溢出等问题。若想完成百万原子级别的计算，则必须解决这些数组的内存问题。</p>
<h1 id="总结与展望">总结与展望</h1>
<h2 id="总结">总结</h2>
<p>本工作专注于在神威平台上优化基于第一性原理的分子模拟软件FHI-aims。通过Hamiltonian矩阵分布式存储优化，将测试体系推向15万原子，为后续探索大体系的物理性质提供一个参考。根据格点位置和首次运行时间实现的动静态负载能够有效平衡各个进程的负荷并减少泊松求解器的计算。最后针对神威的体系结构进行多层并行和访存优化，一定程度上提升了计算速度。前两者为算法层面的优化，针对神威的优化手段可为相类似的情况提供借鉴。本工作为基于量子力学方法的分子模拟软件在国产超算平台上的大规模并行优化提供了一个参考思路。</p>
<h2 id="展望">展望</h2>
<p>随着科技和研发工艺的进步，每秒可计算百亿亿次运算的超级计算机（E级超算）将变成下一代超算的主流，提供超大算力，助力生物制药，化学反应研究，新材料、新能源研发等领域持续发展。而仅仅有算力是不够的，更需有有优秀的应用来充分发挥其计算能力，例如本文的分子模拟软件，若能结合平台特性，充分发挥其计算性能，不仅能提升该软件应用于新药物构型寻找和材料物理特性挖掘等领域的速度，更能物尽其用，充分展示超算的能力与重要性。目前FHI-aims在神威上的优化还有很长一段路要走，需要投入更多的精力结合应用自身特点与平台的计算特性，以求达到一个较为满意的加速效果。</p>
<ul>
<li>
<p>背景：随着生产力与科技的进步人们对新药物研发和新材料研究提出了更高的要求。基于第一性原理的密度泛函微扰理论（DFPT）在评估均匀电场和相关材料特性的响应中是最为先进的方法之一。</p>
</li>
<li>
<p>问题：但在分子模拟软件包 FHI-aims 中的 DFPT 实现，矩阵的大内存消耗成为其大规模并行计算的瓶颈。</p>
</li>
<li>
<p>主旨/方法：我们在国产超算神威太湖之光上实现一种分布式存储策略，并在此基础上实现动静态负载均衡，同时针对神威体系结构做了相应的并行和访存优化。</p>
</li>
<li>
<p>方法+结果：为此我们消除了全局稀疏矩阵存储并采用局部稠密矩阵与通信过程来克服内存瓶颈，利用首次运行时间和积分格点的位置计算新负载分布来提升负载的均匀程度，采用MPI进程级并行，Athread线程级并行和SIMD数据级并行实现三级并行策略，利用DMA和神威体系结构特点实现访存优化。</p>
</li>
<li>
<p>意义：首次将FHI-aims中的DFPT计算规模推向150,002原子，这为分子模拟软件在国产超算神威平台上的未来大规模并行化的实现和优化提供了重要参考。</p>
</li>
</ul>
<h1 id="附录-编译运行">附录 编译运行</h1>
<p>（1）分别安装依赖库 LAPACK，BLAS和SCALAPACK</p>
<p>（2）修改Makefile</p>
<pre><code class="language-shell"># 设置MPI Fortran编译器
FC = mpif90
# MPI Fortran编译器选项
FFLAGS = -O3 -g -ffree-line-length-none -mieee -cpp
F90FLAGS = $(FFLAGS)
ARCH = arch_generic.f90
MPIFC = $(FC)
USE_MPI      = yes

# MPI C语言编译器
CC           = mpicc
# MPI C语言编译器选项
CFLAGS       = -c -std=gnu99 -O3 -g -mieee

my_mkl = /home/xxx/libx
# LAPACK BLAS 库链接路径
LAPACKBLAS = -mhybrid -static  -L$(my_mkl) -lswlapack    -L$(my_mkl) -lswblas
# SCALAPACK 库链接路径
SCALAPACK = -L/home/xxx/lib/ -lswscalapack
# 运行时库：默认不改
SHM = shm.o /usr/lib64/librt.a
</code></pre>
<p>（3）make -j 4 scalapack.mpi 即可编译</p>
<pre><code class="language-shell">#  输入配置文件 control.in  
#  物理模型: H2O

# 设置初始物理条件
xc                 pz-lda
spin               none
relativistic       none
charge             0.  
#  SCF 收敛阈值设置
occupation_type    gaussian 0.01
mixer              pulay
n_max_pulay        6   
charge_mix_param   0.1 
sc_accuracy_rho    1E-4
sc_accuracy_eev    1E-2
sc_accuracy_etot   1E-6
sc_iter_limit      2      
postprocess_anyway  .true.
# 指定Khon-Sham方程求解方法 
KS_method elsi
# 指定DFPT部分方法与精度
DFPT polar_reduce_memory
dfpt_pulay_steps 6
DFPT_mixing   0.1
DFPT_sc_accuracy_dm   0.01
# 开启分布式存储和负载均衡（本文工作） 
use_local_index .true.
load_balancing .true.

# H原子的基本属性设置，一般不改
species        H
nucleus             1   
mass                1.00794                                     
l_hartree           4   
cut_pot             3.5  1.5  1.0 
basis_dep_cutoff    1e-4
radial_base         24 5.0 
radial_multiplier   1   
angular_grids       specified
division   0.2421   50  
division   0.3822  110 
division   0.4799  194 
division   0.5341  302 
outer_grid  302

#  最小基函数设置，不改动：valence basis states                             
valence      1  s   1.  
#     ion occupancy
ion_occ      1  s   0.5 

# 可增加的基函数，需要就取消对应注释
#  &quot;First tier&quot; - improvements: -1014.90 meV to -62.69 meV
#     hydro 2 s 2.1
#     hydro 2 p 3.5
#  &quot;Second tier&quot; - improvements: -12.89 meV to -1.83 meV
#     hydro 1 s 0.85
#     hydro 2 p 3.7
#     hydro 2 s 1.2
#     hydro 3 d 7
#  &quot;Third tier&quot; - improvements: -0.25 meV to -0.12 meV
#     hydro 4 f 11.2
#     hydro 3 p 4.8
#     hydro 4 d 9
#     hydro 3 s 3.2   
</code></pre>
<pre><code class="language-shell"># 1号氢原子坐标
5 atom    0.00000  0.00000   0.00000     H
# 2号氢原子坐标
6 atom    1.34600  0.00000   0.00000     H
</code></pre>
<h1 id="修改建议">修改建议</h1>
<p>1.aims中有三种矩阵存储模式(scalapack, ntpoly, 格点局域)，以及这些矩阵是怎么转换的，需要详细写清楚。</p>
<p>2.Sumup里面的插桩做热点，结果是什么，你具体怎么测试的,这些都要写清楚</p>
<p>3.负载均衡的背景介绍，你写的代码属于哪种代码均衡，都要写</p>
<p>4.大规模测试的数据，最大多少原子，哪些通过了，哪些没用过，为什么，都要分析清楚。理论上分布式存储矩阵，应该可以突破100万原子，我们的代码目前没有实现，为什么？</p>
<p>5.你曾经讨论过负载均衡前后sumup的变化。这个讨论和结果也要写进去。</p>
<p>1.全局稀疏矩阵存储是中小体系的默认算法，关于全局存储方法需要加一节来介绍。包括H矩阵怎么用evalute算出来，然后用allreduce转成全局稀疏矩阵，最后稀疏矩阵怎么转成scalapack格式。</p>
<p>2.全局稀疏和local index矩阵之间的对比也在一张图里面展示一下。可以举个例子，全局稀疏矩阵会导致大体系(15万)无法进行，所以引出local index在大体系计算中的必要性。</p>
<p>3.第11页那个流程图里面，置换的过程加一个图像表示一下。</p>
<p>4.local index对H和rho的贡献是降低了内存使用，减少了一次矩阵转换。(全局时是局域-稀疏-scalapack;用了你写的local index后是局域-scalapack),这一点要提，结果里面最好有数据体现。</p>
<p>5.神威上的优化：主核版上做的优化也可以写</p>
<ul>
<li>
<p>题目名称：第一性原理软件FHI-aims在神威平台上的移植和优化</p>
</li>
<li>
<p>三级并行中SIMD一般不叫并行，叫做向量化或核内优化（本科论文暂时不改，投A期刊再改）</p>
</li>
<li>
<p>神威优化最好能细致的展示每个优化点的效果，细致到每个函数用了哪个优化点的效果，参考明川师兄的论文（答辩前最好能做出来）</p>
</li>
<li>
<p><strong>一阶Hamiltonian矩阵的分布式存储</strong>（DFPT中）</p>
</li>
</ul>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>王荣生1，杨际祥1, 2，王凡2. (2010). 负载均衡策略研究综述. 小型微型计算机系统, 31(8), 1681. http://xwxt.sict.ac.cn/CN/abstract/article_1802.shtml <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>Shreedhar, M., and George Varghese. “Efficient Fair Queueing Using Deficit Round-Robin.” IEEE ACM Transactions on Networking, vol. 4, no. 3, 1996, pp. 375–385. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>Shepherd, F. B., and P. J. Winzer. “Selective Randomized Load Balancing and Mesh Networks with Changing Demands.” Journal of Optical Networking, vol. 5, no. 5, 2006, pp. 320–339. <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>Alakeel, A. M. (2010). A Guide to Dynamic Load Balancing in Distributed Computer Systems. IJCSNS International Journal of Computer Science and Network Security, 10(6), 153–160. http://paper.ijcsns.org/07_book/201006/20100619.pdf <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p>Goux, J. P., et al. “An Enabling Framework for Master-Worker Applications on the Computational Grid.” Proceedings the Ninth International Symposium on High-Performance Distributed Computing, 2000, pp. 43–50. <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p>Alakeel, A. M. (2010). A Guide to Dynamic Load Balancing in Distributed Computer Systems. IJCSNS International Journal of Computer Science and Network Security, 10(6), 153–160. http://paper.ijcsns.org/07_book/201006/20100619.pdf <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E6%91%98%E8%A6%81">摘要</a></li>
<li><a href="#%E8%8B%B1%E6%96%87%E6%91%98%E8%A6%81">英文摘要</a></li>
<li><a href="#%E7%BB%AA%E8%AE%BA">绪论</a>
<ul>
<li><a href="#%E7%A0%94%E7%A9%B6%E8%83%8C%E6%99%AF%E5%92%8C%E6%84%8F%E4%B9%89">研究背景和意义</a></li>
<li><a href="#%E7%A0%94%E7%A9%B6%E7%8E%B0%E7%8A%B6%E5%92%8C%E6%8C%91%E6%88%98">研究现状和挑战</a></li>
<li><a href="#%E6%9C%AC%E6%96%87%E7%9A%84%E7%A0%94%E7%A9%B6%E5%86%85%E5%AE%B9%E5%92%8C%E5%88%9B%E6%96%B0%E7%82%B9">本文的研究内容和创新点</a></li>
<li><a href="#%E6%9C%AC%E6%96%87%E7%9A%84%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84%E5%92%8C%E7%AB%A0%E8%8A%82%E5%AE%89%E6%8E%92">本文的组织结构和章节安排</a></li>
</ul>
</li>
<li><a href="#%E8%83%8C%E6%99%AF">背景</a>
<ul>
<li><a href="#fhi-aims">FHI-aims</a></li>
<li><a href="#%E5%AF%86%E5%BA%A6%E6%B3%9B%E5%87%BD%E5%BE%AE%E6%89%B0%E7%90%86%E8%AE%BA">密度泛函微扰理论</a></li>
<li><a href="#%E7%A5%9E%E5%A8%81%E5%A4%AA%E6%B9%96%E4%B9%8B%E5%85%89">神威太湖之光</a></li>
</ul>
</li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%9F%A9%E9%98%B5">分布式存储矩阵</a>
<ul>
<li><a href="#%E4%B8%89%E7%B1%BB%E7%9F%A9%E9%98%B5%E5%AD%98%E5%82%A8">三类矩阵存储</a>
<ul>
<li><a href="#%E5%8E%8B%E7%BC%A9%E7%A8%80%E7%96%8F%E7%9F%A9%E9%98%B5%E8%A1%8Ccsr">压缩稀疏矩阵行CSR</a>
<ul>
<li><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a></li>
<li><a href="#%E7%A8%A0%E5%AF%86%E7%9F%A9%E9%98%B5%E6%9E%84%E9%80%A0csr">稠密矩阵构造CSR</a></li>
<li><a href="#csr-%E8%BF%98%E5%8E%9F%E7%A8%A0%E5%AF%86%E7%9F%A9%E9%98%B5">CSR 还原稠密矩阵</a></li>
</ul>
</li>
<li><a href="#scalapack%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9F%A9%E9%98%B5%E5%AD%98%E5%82%A8">ScaLAPACK的分布式矩阵存储</a>
<ul>
<li><a href="#%E4%B8%80%E7%BB%B4%E6%95%B0%E6%8D%AE%E5%9D%97%E5%BE%AA%E7%8E%AF%E5%88%86%E5%B8%83">一维数据块循环分布</a></li>
<li><a href="#%E4%BA%8C%E7%BB%B4%E6%95%B0%E6%8D%AE%E5%9D%97%E5%BE%AA%E7%8E%AF%E5%88%86%E5%B8%83">二维数据块循环分布</a></li>
</ul>
</li>
<li><a href="#ntpoly%E7%9F%A9%E9%98%B5%E6%A0%BC%E5%BC%8F">NTPoly矩阵格式</a></li>
</ul>
</li>
<li><a href="#hamiltonian%E7%9F%A9%E9%98%B5%E8%AE%A1%E7%AE%97">Hamiltonian矩阵计算</a>
<ul>
<li><a href="#%E8%AE%A1%E7%AE%97%E6%B5%81%E7%A8%8B%E6%A6%82%E8%BF%B0">计算流程概述</a></li>
<li><a href="#%E5%86%85%E5%AD%98%E7%93%B6%E9%A2%88">内存瓶颈</a></li>
</ul>
</li>
<li><a href="#hamiltonian-%E7%9F%A9%E9%98%B5%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8">Hamiltonian 矩阵分布式存储</a>
<ul>
<li><a href="#%E7%A7%AF%E5%88%86%E6%A0%BC%E7%82%B9-%E5%9F%BA%E5%87%BD%E6%95%B0%E5%92%8Cbatch%E5%88%92%E5%88%86">积分格点、基函数和Batch划分</a></li>
<li><a href="#batch-%E7%9F%A9%E9%98%B5%E5%85%83%E4%B8%8E%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%98%A0%E5%B0%84">Batch、矩阵元与进程的映射</a></li>
<li><a href="#%E7%9F%A9%E9%98%B5%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2">矩阵格式转换</a>
<ul>
<li><a href="#%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E6%8E%A5%E5%8F%A3mpi">消息传递接口MPI</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1">消息通信</a></li>
</ul>
</li>
<li><a href="#%E5%AF%B9%E8%AE%A1%E7%AE%97%E6%A0%B8%E5%BF%83%E7%9A%84%E5%BD%B1%E5%93%8D">对计算核心的影响</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%8A%A8%E9%9D%99%E6%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">动静态负载均衡</a>
<ul>
<li><a href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D">背景介绍</a>
<ul>
<li><a href="#%E9%9D%99%E6%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">静态负载均衡</a></li>
<li><a href="#%E5%8A%A8%E6%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">动态负载均衡</a></li>
</ul>
</li>
<li><a href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84">整体架构</a></li>
<li><a href="#%E8%B4%9F%E8%BD%BD%E5%88%86%E5%B8%83%E7%9A%84%E8%AE%A1%E7%AE%97">负载分布的计算</a></li>
<li><a href="#%E7%BD%AE%E6%8D%A2%E9%87%8D%E6%8E%92">置换重排</a></li>
<li><a href="#%E5%AF%B9%E6%B3%8A%E6%9D%BE%E6%B1%82%E8%A7%A3%E5%99%A8%E7%9A%84%E5%BD%B1%E5%93%8D">对泊松求解器的影响</a></li>
</ul>
</li>
<li><a href="#%E7%A5%9E%E5%A8%81%E5%B9%B3%E5%8F%B0%E4%BC%98%E5%8C%96">神威平台优化</a>
<ul>
<li><a href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87">前置准备</a>
<ul>
<li><a href="#%E7%83%AD%E7%82%B9%E5%AE%9A%E4%BD%8D">热点定位</a></li>
<li><a href="#fortran%E8%BD%ACc%E8%AF%AD%E8%A8%80">Fortran转C语言</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E7%BA%A7%E5%B9%B6%E8%A1%8C%E7%AD%96%E7%95%A5">三级并行策略</a>
<ul>
<li><a href="#%E5%B9%B6%E8%A1%8C%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88">并行设计概览</a></li>
<li><a href="#athread%E5%B9%B6%E8%A1%8C%E5%88%92%E5%88%86%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1">Athread并行划分算法设计</a></li>
<li><a href="#simd%E6%8C%87%E4%BB%A4%E9%9B%86%E5%B9%B6%E8%A1%8C">SIMD指令集并行</a></li>
</ul>
</li>
<li><a href="#%E8%AE%BF%E5%AD%98%E4%BC%98%E5%8C%96">访存优化</a>
<ul>
<li><a href="#%E7%AE%80%E5%8D%95-dma">简单 DMA</a></li>
<li><a href="#loop-tiling">Loop Tiling</a>
<ul>
<li><a href="#tiling%E4%BB%8B%E7%BB%8D">tiling介绍</a></li>
<li><a href="#tiling-%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6">tiling 编程框架</a></li>
</ul>
</li>
<li><a href="#%E8%AE%A1%E7%AE%97%E9%80%9A%E4%BF%A1%E9%9A%90%E8%97%8F">计算通信隐藏</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C">实验结果</a>
<ul>
<li><a href="#%E7%B2%BE%E5%BA%A6%E9%AA%8C%E8%AF%81">精度验证</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E7%BB%93%E6%9E%9C">性能结果</a>
<ul>
<li><a href="#hamiltonian%E7%9F%A9%E9%98%B5%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8">Hamiltonian矩阵分布式存储</a></li>
<li><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">负载均衡</a></li>
<li><a href="#%E7%A5%9E%E5%A8%81%E4%BC%98%E5%8C%96">神威优化</a></li>
</ul>
</li>
<li><a href="#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7">可扩展性</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B">总结与展望</a>
<ul>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
<li><a href="#%E5%B1%95%E6%9C%9B">展望</a></li>
</ul>
</li>
<li><a href="#%E9%99%84%E5%BD%95-%E7%BC%96%E8%AF%91%E8%BF%90%E8%A1%8C">附录 编译运行</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9%E5%BB%BA%E8%AE%AE">修改建议</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://wyjoutstanding.github.io/post/hello-gridea/">
              <h3 class="post-title">
                Hello Gridea
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://wyjoutstanding.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
